<?php

require_once('for_php7.php');


class knjd210sQuery extends Query {

    //存在チェック（在籍データ）
    function ChecktoSchregno($model, $flg = "") {
        $db = Query::dbCheckOut();

        $query  = " SELECT COUNT(*) ";
        //FI対応
        if ($model->Properties["useFi_Hrclass"] == '1' && $flg == "FI") {
            $query .= " FROM   SCHREG_REGD_FI_DAT ";
        } else {
            $query .= " FROM   SCHREG_REGD_DAT ";
        }
        $query .= " WHERE  YEAR='".CTRL_YEAR."' AND SEMESTER='".$model->seme_sch."' AND GRADE='".$model->grade."' ";
        $query .= "    AND HR_CLASS IS NOT NULL ";
        $query .= "    AND COURSECD IS NOT NULL ";
        $query .= "    AND MAJORCD IS NOT NULL ";
        $query .= "    AND COURSECODE IS NOT NULL ";

        $ret_val = $db->getOne($query);

        Query::dbCheckIn($db);
        return $ret_val;
    }

    //存在チェック（成績データ）
    function ChecktoRecordScore($model) {
        $db = Query::dbCheckOut();

        $query  = " SELECT COUNT(*) ";
        $query .= " FROM   RECORD_SCORE_DAT ";
        $query .= " WHERE ";
        $query .= "        YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND SEMESTER = '{$model->seme}' ";
        $query .= "    AND TESTKINDCD = '{$model->kind}' ";
        $query .= "    AND TESTITEMCD = '{$model->item}' ";
        $query .= "    AND SCORE_DIV = '{$model->sdiv}' ";
        $query .= "    AND SCHOOL_KIND = '{$model->school_kind}' ";

        $ret_val = $db->getOne($query);

        Query::dbCheckIn($db);
        return $ret_val;
    }

    //処理学期
    function GetSemester($seme = "") {
        $query  = " SELECT SEMESTER AS VALUE,SEMESTERNAME AS LABEL,SDATE,EDATE ";
        $query .= " FROM SEMESTER_MST ";
        $query .= " WHERE  YEAR = '".CTRL_YEAR."' ";
        if (strlen($seme)) {
            $query .= "     AND SEMESTER = '{$seme}' ";
        }
        $query .= " ORDER BY VALUE ";
        return $query;
    }

    //処理学年
    function GetGrade($model, $grade = "") {
        $query  = " SELECT GRADE AS VALUE, GRADE_NAME1 AS LABEL, SCHOOL_KIND ";
        $query .= " FROM SCHREG_REGD_GDAT ";
        $query .= " WHERE  YEAR = '".CTRL_YEAR."' ";
        if (strlen($grade)) {
            $query .= "     AND GRADE = '{$grade}' ";
        }
        if ($model->Properties["useSchool_KindField"] == '1' && SCHOOLKIND != '') {
            $query .= " AND SCHOOL_KIND = '".SCHOOLKIND."' ";
        }
        $query .= " ORDER BY VALUE ";
        return $query;
    }

    //処理種別(成績)
    function GetName($seme, $model) {
        $query  = "SELECT T1.TESTKINDCD || '-' || T1.TESTITEMCD || '-' || T1.SCORE_DIV AS VALUE,T1.TESTITEMNAME AS LABEL ";
        $query .= "FROM   TESTITEM_MST_COUNTFLG_NEW_SDIV T1 ";
        $query .= "WHERE  T1.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND T1.SEMESTER = '{$seme}' ";
        $query .= "     AND T1.JYORETSU_FLG = '1' "; //1:序列対象
        //基本設定されたパーツ
        $query .= "     AND T1.SEMESTER || T1.TESTKINDCD || T1.TESTITEMCD || T1.SCORE_DIV IN ( ";
        $query .= "         SELECT ";
        $query .= "             T3.SEMESTER || T3.TESTKINDCD || T3.TESTITEMCD || T3.SCORE_DIV ";
        $query .= "         FROM ";
        $query .= "             ADMIN_CONTROL_SDIV_DAT T3 ";
        $query .= "         WHERE ";
        $query .= "             T3.YEAR = '".CTRL_YEAR."' ";
        $query .= "         AND T3.CLASSCD = '00' ";
        $query .= "         AND T3.SCHOOL_KIND = '{$model->school_kind}' ";
        $query .= "         AND T3.CURRICULUM_CD = '00' ";
        $query .= "         AND T3.SUBCLASSCD = '000000' ";
        $query .= "         ) ";
        $query .= "ORDER BY VALUE ";
        return $query;
    }

    //処理科目
    function getSubclasscd($model) {
        $year = CTRL_YEAR;
        $seme = ($model->seme != "9") ? $model->seme : CTRL_SEMESTER;
        $staffcd = STAFFCD;

        $query  = " SELECT ";
        $query .= "     CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD || ':' || SUBCLASSNAME AS LABEL, ";
        $query .= "     CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD AS VALUE ";
        $query .= " FROM ";
        $query .= "     V_SUBCLASS_MST ";
        $query .= " WHERE ";
        $query .= "     YEAR = '{$year}' ";
        $query .= "     AND SCHOOL_KIND = '{$model->school_kind}' ";
        //更新可能(制限付)
        if (AUTHORITY != DEF_UPDATABLE) {
            $query .= "     AND CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD IN ( ";
            $query .= "         SELECT ";
            $query .= "             T1.CLASSCD || '-' || T1.SCHOOL_KIND || '-' || T1.CURRICULUM_CD || '-' || T1.SUBCLASSCD ";
            $query .= "         FROM ";
            $query .= "             CHAIR_DAT T1, ";
            $query .= "             CHAIR_STD_DAT T2, ";
            $query .= "             CHAIR_STF_DAT T4 ";
            $query .= "         WHERE ";
            $query .= "                 T1.YEAR       = '{$year}' ";
            $query .= "             AND T1.SEMESTER   = '{$seme}' ";
            $query .= "             AND SUBSTR(T1.SUBCLASSCD, 1 ,2) <= '90' ";
            $query .= "             AND T2.YEAR       = T1.YEAR ";
            $query .= "             AND T2.SEMESTER   = T1.SEMESTER ";
            $query .= "             AND T2.CHAIRCD    = T1.CHAIRCD ";
            $query .= "             AND T4.YEAR       = T1.YEAR ";
            $query .= "             AND T4.SEMESTER   = T1.SEMESTER ";
            $query .= "             AND T4.CHAIRCD    = T1.CHAIRCD ";
            $query .= "             AND T4.STAFFCD    = '{$staffcd}' "; //ログインした先生
            $query .= "         GROUP BY ";
            $query .= "             T1.CLASSCD, ";
            $query .= "             T1.SCHOOL_KIND, ";
            $query .= "             T1.CURRICULUM_CD, ";
            $query .= "             T1.SUBCLASSCD ";
            $query .= "     ) ";
        }
        $query .= " ORDER BY ";
        $query .= "     VALUE ";

        return $query;
    }
    //履歴一覧
    function getListRireki($model) {
        $year = CTRL_YEAR;
        $query  = " SELECT ";
        $query .= "     T1.CALC_DATE, ";
        $query .= "     T1.CALC_TIME, ";
        $query .= "     T1.CLASSCD || '-' || T1.SCHOOL_KIND || '-' || T1.CURRICULUM_CD || '-' || T1.SUBCLASSCD AS SUBCLASSCD, ";
        $query .= "     L1.SUBCLASSNAME, ";
        $query .= "     L2.GRADE_NAME1, ";
        $query .= "     L3.SEMESTERNAME, ";
        $query .= "     L4.TESTITEMNAME, ";
        $query .= "     T1.CHAIRDATE ";
        $query .= " FROM ";
        $query .= "     RECORD_RANK_EXEC_SDIV_DAT T1 ";
        $query .= "     LEFT JOIN SUBCLASS_MST L1 ON L1.SUBCLASSCD = T1.SUBCLASSCD ";
        $query .= "                              AND L1.CLASSCD = T1.CLASSCD ";
        $query .= "                              AND L1.SCHOOL_KIND = T1.SCHOOL_KIND ";
        $query .= "                              AND L1.CURRICULUM_CD = T1.CURRICULUM_CD ";
        $query .= "     LEFT JOIN SCHREG_REGD_GDAT L2 ON L2.YEAR = T1.YEAR AND L2.GRADE = T1.GRADE ";
        $query .= "     LEFT JOIN SEMESTER_MST L3 ON L3.YEAR = T1.YEAR AND L3.SEMESTER = T1.SEMESTER ";
        $query .= "     LEFT JOIN TESTITEM_MST_COUNTFLG_NEW_SDIV L4 ON L4.YEAR = T1.YEAR AND L4.SEMESTER = T1.SEMESTER AND L4.TESTKINDCD = T1.TESTKINDCD AND L4.TESTITEMCD = T1.TESTITEMCD AND L4.SCORE_DIV = T1.SCORE_DIV ";
        $query .= " WHERE ";
        $query .= "     T1.YEAR = '{$year}' ";
        $query .= "     AND T1.SEMESTER = '{$model->seme}' ";
        $query .= "     AND T1.TESTKINDCD || '-' || T1.TESTITEMCD || '-' || T1.SCORE_DIV = '{$model->exam}' ";
        $query .= "     AND T1.GRADE = '{$model->grade}' ";
        $query .= " ORDER BY ";
        $query .= "     T1.CALC_DATE DESC, ";
        $query .= "     T1.CALC_TIME DESC ";
        return $query;
    }
    /* 実行履歴 */
    function executeRireki($model) {
        $db = Query::dbCheckOut();
        $db->autoCommit(false);

        //実行日付・時間を取得
        $calcRow = $db->getRow(knjd210sQuery::getCalcDateTime(), DB_FETCHMODE_ASSOC);
        $calcDate = $calcRow["CALC_DATE"];//実行日付
        $calcTime = $calcRow["CALC_TIME"];//実行時間
        //実行履歴データ・追加
        $query = knjd210sQuery::getInsertRireki($calcDate, $calcTime, $model);
        $db->query($query);

        $db->commit();
        Query::dbCheckIn($db);
        return true;
    }
    //実行日付・時間を取得
    function getCalcDateTime() {
        $query  = " with t_date_time (CALC_DATE,CALC_TIME) as ( ";
        $query .= " values( ";
        $query .= "     date(sysdate()), ";
        $query .= "     time(sysdate()) ";
        $query .= " )) ";
        $query .= "  ";
        $query .= " select * from t_date_time ";
        return $query;
    }
    //実行履歴データ・追加
    function getInsertRireki($calcDate, $calcTime, $model) {
        $data = array();
        $data["CALC_DATE"][TEXT]            = $calcDate;
        $data["CALC_TIME"][TEXT]            = $calcTime;

        //処理科目(総合計のみ または 全て)
        if ($model->subclasscd == '999999' || $model->subclasscd == '') {
            //ダミーデータセット(00)
            $data["CLASSCD"][TEXT]          = "00";
            $data["SCHOOL_KIND"][TEXT]      = $model->school_kind;
            $data["CURRICULUM_CD"][TEXT]    = "00";
            $data["SUBCLASSCD"][TEXT]       = $model->subclasscd == '999999' ? $model->subclasscd : "ALL";
        //処理科目(各科目のみ)
        } else if ($model->subclasscd != '') {
            $subArray = array();
            $subArray = explode("-", $model->subclasscd);
            $data["CLASSCD"][TEXT]          = $subArray[0];
            $data["SCHOOL_KIND"][TEXT]      = $subArray[1];
            $data["CURRICULUM_CD"][TEXT]    = $subArray[2];
            $data["SUBCLASSCD"][TEXT]       = $subArray[3];
        }

        $data["YEAR"][TEXT]                 = CTRL_YEAR;
        $data["SEMESTER"][TEXT]             = $model->seme;
        $data["TESTKINDCD"][TEXT]           = $model->kind;
        $data["TESTITEMCD"][TEXT]           = $model->item;
        $data["SCORE_DIV"][TEXT]            = $model->sdiv;
        $data["GRADE"][TEXT]                = $model->grade;
        $data["CHAIRDATE"][TEXT]            = str_replace("/", "-", $model->chairdate);
        $data["REGISTERCD"][TEXT]           = STAFFCD;
        $data["UPDATED"][FUNC]              = "sysdate()";
        $query = Query::insertSQL($data, "RECORD_RANK_EXEC_SDIV_DAT");
        return $query;
    }


    /* 実行 */
    function ExecuteQuery(&$model) {
        $db = Query::dbCheckOut();
        $db->autoCommit(false);
        $model->z010 = $db->getOne(" SELECT NAME1 FROM NAME_MST WHERE NAMECD1 = 'Z010' AND NAMECD2 = '00' ");

        // -- アルファベット順に更新するようにした。--

        // RECORD_AVERAGE_CHAIR_DAT---各講座の合計・最高点・最低点・人数・平均・標準偏差を保持
        //FI対応
        if ($model->Properties["useFi_Hrclass"] == '1') {
            knjd210squery::insertSubclassQuery($db, $model, "record_average_chair");
            $db->commit();
        }

        // RECORD_AVERAGE_DAT---各科目の合計・最高点・最低点・人数・平均・標準偏差を保持
        knjd210squery::insertSubclassQuery($db, $model, "record_average");
        $db->commit();

        // RECORD_RANK_CHAIR_DAT---各講座の順位・偏差値を保持
        //FI対応
        if ($model->Properties["useFi_Hrclass"] == '1') {
            knjd210squery::insertSubclassQuery($db, $model, "record_rank_chair");
            $db->commit();
        }

        // RECORD_RANK_DAT---各科目の順位・偏差値を保持
        knjd210squery::insertSubclassQuery($db, $model, "record_rank");
        $db->commit();

        // -- アルファベット順に更新するようにした。--

        Query::dbCheckIn($db);
        return true;
    }

    /* 科目別の処理 */
    function insertSubclassQuery(&$db, $model, $table) {
        $query  = "";
        //削除クエリー
        $query  = knjd210sQuery::getDeleteQuery($model, $table);
        $db->query($query);
        //追加クエリー
        $query  = knjd210sQuery::getInsertSubclassQuery($model, $table);
        $result = $db->query($query); 
        while ($row = $result->fetchRow(DB_FETCHMODE_ASSOC))
        {
            //項目
            $data = knjd210sQuery::getFieldData($model, $table, $row);
            //追加
            $query = Query::insertSQL($data, $table .$model->tableStr);
            $db->query($query);
        }
        return;
    }

    //削除クエリー
    function getDeleteQuery($model, $table) {
        $query  = "";
        if ($table == "record_average" || $table == "record_average_chair") {
            $query .= "DELETE FROM " .$table .$model->tableStr ." ";
            $query .= "where YEAR       = '".CTRL_YEAR."' ";
            $query .= "  and SEMESTER   = '".$model->seme."' ";
            $query .= "  and TESTKINDCD = '".$model->kind."' ";
            $query .= "  and TESTITEMCD = '".$model->item."' ";
            $query .= "  and SCORE_DIV  = '".$model->sdiv."' ";
            $query .= "  and GRADE      = '".$model->grade."' ";
            //処理科目(総合計のみ)
            if ($model->subclasscd == '999999') {
                $query .= "  and SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
            //処理科目(各科目のみ)
            } else if ($model->subclasscd != '') {
                $query .= "  and CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD = '".$model->subclasscd."' ";
            }
        }
        if ($table == "record_rank" || $table == "record_rank_chair") {
            $query .= "DELETE FROM " .$table .$model->tableStr ." ";
            $query .= "where YEAR       = '".CTRL_YEAR."' ";
            $query .= "  and SEMESTER   = '".$model->seme."' ";
            $query .= "  and TESTKINDCD = '".$model->kind."' ";
            $query .= "  and TESTITEMCD = '".$model->item."' ";
            $query .= "  and SCORE_DIV  = '".$model->sdiv."' ";
            $query .= "  and SCHREGNO   in (SELECT SCHREGNO FROM ( ";
            $query .= knjd210sQuery::getSchregQuery($model);
            $query .= "  ) t1 ) ";
            //処理科目(総合計のみ)
            if ($model->subclasscd == '999999') {
                $query .= "  and SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
            //処理科目(各科目のみ)
            } else if ($model->subclasscd != '') {
                $query .= "  and CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD = '".$model->subclasscd."' ";
            }
        }
        return $query;
    }

    //項目
    function getFieldData($model, $table, $data2) {
        $data = array();
        if ($table == "record_average" || $table == "record_average_chair") {
            $data["YEAR"][TEXT]         = CTRL_YEAR;
            $data["SEMESTER"][TEXT]     = $model->seme;
            $data["TESTKINDCD"][TEXT]   = $model->kind;
            $data["TESTITEMCD"][TEXT]   = $model->item;
            $data["SCORE_DIV"][TEXT]    = $model->sdiv;
            $data["CLASSCD"][TEXT]      = $data2["CLASSCD"];
            $data["SCHOOL_KIND"][TEXT]  = $data2["SCHOOL_KIND"];
            $data["CURRICULUM_CD"][TEXT]= $data2["CURRICULUM_CD"];
            $data["SUBCLASSCD"][TEXT]   = $data2["SUBCLASSCD"];
            if ($table == "record_average_chair") {
                $data["CHAIRCD"][TEXT]   = $data2["CHAIRCD"];
            }
            $data["AVG_DIV"][TEXT]      = $data2["AVG_DIV"];
            $data["GRADE"][TEXT]        = $data2["GRADE"];
            $data["HR_CLASS"][TEXT]     = $data2["HR_CLASS"];
            $data["COURSECD"][TEXT]     = $data2["COURSECD"];
            $data["MAJORCD"][TEXT]      = $data2["MAJORCD"];
            $data["COURSECODE"][TEXT]   = $data2["COURSECODE"];
            $data["SCORE"][NUMBER]      = $data2["SCORE"];
            $data["HIGHSCORE"][NUMBER]  = $data2["HIGHSCORE"];
            $data["LOWSCORE"][NUMBER]   = $data2["LOWSCORE"];
            $data["COUNT"][NUMBER]      = $data2["COUNT"];
            $data["AVG"][NUMBER]        = $data2["AVG"];
            $data["STDDEV"][NUMBER]     = $data2["STDDEV"];
            if ($table == "record_average_chair") {
                $data["CHAIRDATE"][TEXT]    = str_replace("/", "-", $model->chairdate);
            }
            $data["REGISTERCD"][TEXT]   = STAFFCD;
            $data["UPDATED"][FUNC]      = "SYSDATE()";
        }
        if ($table == "record_rank" || $table == "record_rank_chair") {
            $data["YEAR"][TEXT]         = CTRL_YEAR;
            $data["SEMESTER"][TEXT]     = $model->seme;
            $data["TESTKINDCD"][TEXT]   = $model->kind;
            $data["TESTITEMCD"][TEXT]   = $model->item;
            $data["SCORE_DIV"][TEXT]    = $model->sdiv;
            $data["CLASSCD"][TEXT]      = $data2["CLASSCD"];
            $data["SCHOOL_KIND"][TEXT]  = $data2["SCHOOL_KIND"];
            $data["CURRICULUM_CD"][TEXT]= $data2["CURRICULUM_CD"];
            $data["SUBCLASSCD"][TEXT]   = $data2["SUBCLASSCD"];
            if ($table == "record_rank_chair") {
                $data["CHAIRCD"][TEXT]   = $data2["CHAIRCD"];
            }
            $data["SCHREGNO"][TEXT]     = $data2["SCHREGNO"];
            $data["SCORE"][NUMBER]      = $data2["SCORE"];
            $data["AVG"][NUMBER]        = $data2["AVG"];
            $data["GRADE_RANK"][NUMBER]         = $data2["GRADE_RANK"];
            $data["GRADE_AVG_RANK"][NUMBER]     = $data2["GRADE_AVG_RANK"];
            $data["GRADE_DEVIATION"][NUMBER]    = $data2["GRADE_DEVIATION"];
            $data["CLASS_RANK"][NUMBER]         = $data2["CLASS_RANK"];
            $data["CLASS_AVG_RANK"][NUMBER]     = $data2["CLASS_AVG_RANK"];
            $data["CLASS_DEVIATION"][NUMBER]    = $data2["CLASS_DEVIATION"];
            $data["COURSE_RANK"][NUMBER]        = $data2["COURSE_RANK"];
            $data["COURSE_AVG_RANK"][NUMBER]    = $data2["COURSE_AVG_RANK"];
            $data["COURSE_DEVIATION"][NUMBER]   = $data2["COURSE_DEVIATION"];
            $data["MAJOR_RANK"][NUMBER]         = $data2["MAJOR_RANK"];
            $data["MAJOR_AVG_RANK"][NUMBER]     = $data2["MAJOR_AVG_RANK"];
            $data["MAJOR_DEVIATION"][NUMBER]    = $data2["MAJOR_DEVIATION"];
            if ($table == "record_rank_chair") {
                $data["CHAIRDATE"][TEXT]    = str_replace("/", "-", $model->chairdate);
            }
            $data["REGISTERCD"][TEXT]   = STAFFCD;
            $data["UPDATED"][FUNC]      = "SYSDATE()";
        }
        return $data;
    }

    //（共通）追加クエリー
    function getInsertCommonQuery($model, $table) {
        $query  = "";
        //在籍
        $query .= "WITH T_SCHREG AS ( ";
        $query .= knjd210sQuery::getSchregQuery($model);
        $query .= "    ) ";
        //FI対応
        if ($model->Properties["useFi_Hrclass"] == '1') {
            //重み付合併設定
            $query .= ",T_WEIGHTING AS ( ";
            $query .= "    SELECT ";
            $query .= "        T1.SCHREGNO, ";
            $query .= "        T2.ATTEND_CLASSCD, ";
            $query .= "        T2.ATTEND_SCHOOL_KIND, ";
            $query .= "        T2.ATTEND_CURRICULUM_CD, ";
            $query .= "        T2.ATTEND_SUBCLASSCD ";
            $query .= "    FROM ";
            $query .= "        T_SCHREG T1 ";
            $query .= "        INNER JOIN SUBCLASS_WEIGHTING_COURSE_DAT T2 ";
            $query .= "             ON T2.YEAR = '".CTRL_YEAR."' ";
            $query .= "            AND T2.GRADE = T1.GRADE ";
            $query .= "            AND T2.COURSECD = T1.COURSECD ";
            $query .= "            AND T2.MAJORCD = T1.MAJORCD ";
            $query .= "            AND T2.COURSECODE = T1.COURSECODE ";
            if ($model->kind == '99') {
                $query .= "        AND T2.FLG = '2' ";
            } else {
                $query .= "        AND T2.FLG = '1' ";
            }
            $query .= "    ) ";
        }
        //選択科目
        $query .= ",T_SELECT_SUBCLASS AS ( ";
        $query .= "    SELECT ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        T2.CLASSCD, ";
        $query .= "        T2.SCHOOL_KIND, ";
        $query .= "        T2.CURRICULUM_CD, ";
        $query .= "        T2.SUBCLASSCD ";
        $query .= "    FROM ";
        $query .= "        T_SCHREG T1 ";
        $query .= "        INNER JOIN CREDIT_MST T2 ";
        $query .= "             ON T2.YEAR = '".CTRL_YEAR."' ";
        $query .= "            AND T2.COURSECD = T1.COURSECD ";
        $query .= "            AND T2.MAJORCD = T1.MAJORCD ";
        $query .= "            AND T2.GRADE = T1.GRADE ";
        $query .= "            AND T2.COURSECODE = T1.COURSECODE ";
        $query .= "            AND T2.REQUIRE_FLG = '3' ";
        $query .= "    ) ";
        //３科・５科のグループデータ
        $query .= ",T_GROUP AS ( ";
        $query .= "    SELECT ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        T2.GROUP_DIV, "; //3:３科 5:５科
        $query .= "        T2.CLASSCD, ";
        $query .= "        T2.SCHOOL_KIND, ";
        $query .= "        T2.CURRICULUM_CD, ";
        $query .= "        T2.SUBCLASSCD ";
        $query .= "    FROM ";
        $query .= "        T_SCHREG T1 ";
        $query .= "        LEFT JOIN REC_SUBCLASS_GROUP_DAT T2 ";
        $query .= "             ON T2.YEAR = '".CTRL_YEAR."' ";
        $query .= "            AND T2.GRADE = T1.GRADE ";
        $query .= "            AND T2.COURSECD = T1.COURSECD ";
        $query .= "            AND T2.MAJORCD = T1.MAJORCD ";
        $query .= "            AND T2.COURSECODE = T1.COURSECODE ";
        $query .= "    ) ";
        //成績
        $query .= ",T_SCORE AS ( ";
        $query .= knjd210sQuery::getRecordQuery($model);
        $query .= "    ) ";
        if ($table == "record_average" || $table == "record_rank") {
            //SCOREがNULLの学籍番号を取得
            $query .= ",T_SCORE_NULL AS ( ";
            $query .= knjd210sQuery::getRecordNullQuery($model, "9");
            $query .= "    ) ";
            $query .= ",T_SCORE_NULL3 AS ( ";
            $query .= knjd210sQuery::getRecordNullQuery($model, "3");
            $query .= "    ) ";
            $query .= ",T_SCORE_NULL5 AS ( ";
            $query .= knjd210sQuery::getRecordNullQuery($model, "5");
            $query .= "    ) ";
            $query .= ",T_SCORE_NULL8 AS ( ";
            $query .= knjd210sQuery::getRecordNullQuery($model, "8");
            $query .= "    ) ";
            $query .= ",T_SCORE_NULL7 AS ( ";
            $query .= knjd210sQuery::getRecordNullQuery($model, "7");
            $query .= "    ) ";
            //各生徒の３科目・５科目・全科目のSCOREの合計を取得
            $query .= ",T_SCORE_SUM AS ( ";
            $query .= knjd210sQuery::getRecordScoreSumQuery($model);
            $query .= "    ) ";
        }

        if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
            $query .= ",T_SCORE_RUIKEI AS ( ";
            $query .= knjd210sQuery::getRecordRuikeiQuery($model);

            if ($table == "record_average" || $table == "record_rank") {
                //SCOREがNULLの学籍番号を取得
                $query .= "    ) ";
                $query .= ",T_SCORE_NULL_RUIKEI AS ( ";
                $query .= knjd210sQuery::getRecordNullRuikeiQuery($model, "9");
                $query .= "    ) ";
                $query .= ",T_SCORE_NULL_RUIKEI3 AS ( ";
                $query .= knjd210sQuery::getRecordNullRuikeiQuery($model, "3");
                $query .= "    ) ";
                $query .= ",T_SCORE_NULL_RUIKEI5 AS ( ";
                $query .= knjd210sQuery::getRecordNullRuikeiQuery($model, "5");
                $query .= "    ) ";
                $query .= ",T_SCORE_NULL_RUIKEI8 AS ( ";
                $query .= knjd210sQuery::getRecordNullRuikeiQuery($model, "8");
                $query .= "    ) ";
                $query .= ",T_SCORE_NULL_RUIKEI7 AS ( ";
                $query .= knjd210sQuery::getRecordNullRuikeiQuery($model, "7");
                $query .= "    ) ";
                //各生徒の３科目・５科目・全科目のSCOREの合計を取得
                $query .= ",T_SCORE_SUM_RUIKEI AS ( ";
                $query .= knjd210sQuery::getRecordScoreSumRuikeiQuery($model);
                $query .= "    ) ";
            }
        }
                //在籍&成績２
        $query .= ",T_RANK AS ( ";
        $query .= knjd210sQuery::getRecordSchregQuery($model, $table);
        $query .= "    ) ";
        if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
            $query .= ",T_RANK_RUIKEI AS ( ";
            $query .= knjd210sQuery::getRecordSchregRuikeiQuery($model, $table);
            $query .= "    ) ";
        }

        return $query;
    }//getInsertCommonQuery

    //在籍クエリー
    function getSchregQuery($model) {
        $query  = "";
        //FI対応
        if ($model->Properties["useFi_Hrclass"] == '1' && $model->tableStr == "_fi_sdiv_dat") {
            $query .= "    SELECT ";
            $query .= "        W1.SCHREGNO, ";
            $query .= "        W1.GRADE, ";
            $query .= "        W1.HR_CLASS, ";
            $query .= "        W1.COURSECD,W1.MAJORCD,W1.COURSECODE, ";
            $query .= "        W1.COURSECD||W1.MAJORCD||W1.COURSECODE AS COURSE, ";
            $query .= "        CASE WHEN W2.RECORD_DIV = '1' THEN '001' ELSE '002' END AS MAJOR ";
            $query .= "    FROM ";
            $query .= "        SCHREG_REGD_FI_DAT W1 ";
            $query .= "        LEFT JOIN SCHREG_REGD_FI_HDAT W2 ";
            $query .= "             ON W2.YEAR = W1.YEAR ";
            $query .= "            AND W2.SEMESTER = W1.SEMESTER ";
            $query .= "            AND W2.GRADE = W1.GRADE ";
            $query .= "            AND W2.HR_CLASS = W1.HR_CLASS ";
            $query .= "    WHERE ";
            $query .= "        W1.YEAR = '".CTRL_YEAR."' AND ";
            $query .= "        W1.SEMESTER = '".$model->seme_sch."' AND ";
            $query .= "        W1.GRADE = '".$model->grade."' ";
        } else {
            $query .= "    SELECT ";
            $query .= "        W1.SCHREGNO, ";
            $query .= "        W1.GRADE, ";
            $query .= "        W1.HR_CLASS, ";
            $query .= "        W1.COURSECD,W1.MAJORCD,W1.COURSECODE, ";
            $query .= "        W1.COURSECD||W1.MAJORCD||W1.COURSECODE AS COURSE, ";
            $query .= "        VALUE(W2.GROUP_CD, '000') AS MAJOR ";
            $query .= "    FROM ";
            $query .= "        SCHREG_REGD_DAT W1 ";
            $query .= "        LEFT JOIN COURSE_GROUP_CD_DAT W2 ";
            $query .= "             ON W2.YEAR = W1.YEAR ";
            $query .= "            AND W2.GRADE = W1.GRADE ";
            $query .= "            AND W2.COURSECD = W1.COURSECD ";
            $query .= "            AND W2.MAJORCD = W1.MAJORCD ";
            $query .= "            AND W2.COURSECODE = W1.COURSECODE ";
            $query .= "    WHERE ";
            $query .= "        W1.YEAR = '".CTRL_YEAR."' AND ";
            $query .= "        W1.SEMESTER = '".$model->seme_sch."' AND ";
            $query .= "        W1.GRADE = '".$model->grade."' ";
        }
        return $query;
    }

    //成績クエリー
    function getRecordQuery($model) {
        $testcd = $model->seme . $model->kind . $model->item . $model->sdiv;

        $query  = "";
        //累計用序列テーブル
        //実行条件・・・処理学年：中学・高校、処理種別の小分類が'08'（つまり、ＸＸ得点）
        //累計対象・・・処理種別の小分類が'08'。但し、大中分類が'9900'は除く
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
            $query .= " SELECT ";
            $query .= "     W1.CLASSCD, ";
            $query .= "     W1.SCHOOL_KIND, ";
            $query .= "     W1.CURRICULUM_CD, ";
            $query .= "     W1.SUBCLASSCD, ";
            $query .= "     W1.SCHREGNO, ";
            $query .= "     SUM(VALUE(W1.SCORE,W3.SCORE)) AS SCORE, ";
            $query .= "     MAX(CASE WHEN W3.SCORE IS NULL AND W1.SCORE IS NULL AND W1.VALUE_DI = '*' THEN '*' END) AS VALUE_DI, ";
            $query .= "     SUM(W1.COMP_CREDIT) AS COMP_CREDIT, ";  //TODO2の箇所で使用
            $query .= "     SUM(W1.GET_CREDIT) AS GET_CREDIT ";     //TODO2の箇所で使用
            $query .= " FROM ";
            $query .= "     RECORD_SCORE_DAT W1 ";
            $query .= "     INNER JOIN T_SCHREG W2 ON W2.SCHREGNO = W1.SCHREGNO ";
            $query .= "     LEFT JOIN SUPP_EXA_SDIV_DAT W3 ON W3.YEAR = W1.YEAR ";
            $query .= "             AND W3.SEMESTER = W1.SEMESTER ";
            $query .= "             AND W3.TESTKINDCD = W1.TESTKINDCD ";
            $query .= "             AND W3.TESTITEMCD = W1.TESTITEMCD ";
            $query .= "             AND W3.SCORE_DIV = W1.SCORE_DIV ";
            $query .= "             AND W3.CLASSCD = W1.CLASSCD ";
            $query .= "             AND W3.SCHOOL_KIND = W1.SCHOOL_KIND ";
            $query .= "             AND W3.CURRICULUM_CD = W1.CURRICULUM_CD ";
            $query .= "             AND W3.SUBCLASSCD = W1.SUBCLASSCD ";
            $query .= "             AND W3.SCHREGNO = W1.SCHREGNO ";
            $query .= "             AND W3.SCORE_FLG = '2' ";
            $query .= " WHERE ";
            $query .= "     W1.YEAR = '".CTRL_YEAR."' ";
            $query .= "     AND W1.SCHOOL_KIND = '{$model->school_kind}' ";
            $query .= "     AND W1.SEMESTER || W1.TESTKINDCD || W1.TESTITEMCD || W1.SCORE_DIV <= '{$testcd}' ";
            $query .= "     AND W1.SCORE_DIV = '08' ";
            $query .= "     AND W1.TESTKINDCD || W1.TESTITEMCD NOT IN ('9900') ";
            $query .= " GROUP BY ";
            $query .= "     W1.CLASSCD, ";
            $query .= "     W1.SCHOOL_KIND, ";
            $query .= "     W1.CURRICULUM_CD, ";
            $query .= "     W1.SUBCLASSCD, ";
            $query .= "     W1.SCHREGNO ";
        } else {
            $query .= " SELECT ";
            $query .= "     W1.CLASSCD, ";
            $query .= "     W1.SCHOOL_KIND, ";
            $query .= "     W1.CURRICULUM_CD, ";
            $query .= "     W1.SUBCLASSCD, ";
            $query .= "     W1.SCHREGNO, ";
            $query .= "     W1.SCORE AS SCORE, ";
            $query .= "     CASE WHEN W1.SCORE IS NULL AND W1.VALUE_DI = '*' THEN '*' END AS VALUE_DI, ";
            $query .= "     W1.COMP_CREDIT, ";  //TODO2の箇所で使用
            $query .= "     W1.GET_CREDIT ";    //TODO2の箇所で使用
            $query .= " FROM ";
            $query .= "     RECORD_SCORE_DAT W1 ";
            $query .= "     INNER JOIN T_SCHREG W2 ON W2.SCHREGNO = W1.SCHREGNO ";
            $query .= " WHERE ";
            $query .= "     W1.YEAR = '".CTRL_YEAR."' ";
            $query .= "     AND W1.SCHOOL_KIND = '{$model->school_kind}' ";
            $query .= "     AND W1.SEMESTER || W1.TESTKINDCD || W1.TESTITEMCD || W1.SCORE_DIV  = '{$testcd}' ";
        }
        return $query;
    }

    //(SCOREがNULL)かつ(VALUE_DIが*)の学籍番号を取得するクエリー
    function getRecordNullQuery($model, $div) {
        $query  = "";
        $query .= "    SELECT ";
        $query .= "        T1.SCHREGNO ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        if ($model->z010 == 'bunkyo') {
           $query .= "        (T1.VALUE_DI = '*' OR T1.SCORE IS NULL) ";
        } else {
           $query .= "        T1.VALUE_DI = '*' ";
        }
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        //３科目・５科目
        if ($div != "9" && $div != "8" && $div != "7") {
            $query .= " AND EXISTS( ";
            $query .= "        SELECT ";
            $query .= "            'X' ";
            $query .= "        FROM ";
            $query .= "            T_GROUP W1 ";
            $query .= "        WHERE ";
            $query .= "            W1.GROUP_DIV = '".$div."' AND ";
            $query .= "            W1.SCHREGNO = T1.SCHREGNO AND ";
            $query .= "            W1.CLASSCD = T1.CLASSCD AND ";
            $query .= "            W1.SCHOOL_KIND = T1.SCHOOL_KIND AND ";
            $query .= "            W1.CURRICULUM_CD = T1.CURRICULUM_CD AND ";
            $query .= "            W1.SUBCLASSCD = T1.SUBCLASSCD ";
            $query .= "        ) ";
        //全科目
        } else {
            //888888：選択科目
            if ($div == "8") {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD     in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO ) ";
            }
            //777777：必修科目　（つまり、選択科目を除く）
            if ($div == "7") {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO ) ";
            }
            //教科科目名称マスタのマスタ化
            if ($model->Properties["useClassDetailDat"] == '1') {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
            } else {
                //名称マスタ「D017」NAME1に登録されている科目を除く。
                $query .= " AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
            }
            //教科９０以上は除く。つまり、教科９０未満が対象
            $query .= " AND T1.SUBCLASSCD not like '9%' ";
            //「学年末」の場合、履修単位・修得単位の両方 NULL が対象・・・TODO2
            if ($model->seme == "9") {
                $query .= " AND T1.COMP_CREDIT IS NULL ";
                $query .= " AND T1.GET_CREDIT IS NULL ";
            }
        }
        $query .= "    GROUP BY T1.SCHREGNO ";
        return $query;
    }

    //成績クエリー
    function getRecordRuikeiQuery($model) {
        $testcd = $model->seme . $model->kind . $model->item . $model->sdiv;

        $query  = "";
        $query .= " SELECT ";
        $query .= "     W1.CLASSCD, ";
        $query .= "     W1.SCHOOL_KIND, ";
        $query .= "     W1.CURRICULUM_CD, ";
        $query .= "     W1.SUBCLASSCD, ";
        $query .= "     W1.SCHREGNO, ";
        $query .= "     W1.SEMESTER || W1.TESTKINDCD || W1.TESTITEMCD || W1.SCORE_DIV AS TESTCD, ";
        $query .= "     SUM(VALUE(W1.SCORE,W3.SCORE)) AS SCORE, ";
        $query .= "     MAX(CASE WHEN W3.SCORE IS NULL AND W1.SCORE IS NULL AND W1.VALUE_DI = '*' THEN '*' END) AS VALUE_DI, ";
        $query .= "     SUM(W1.COMP_CREDIT) AS COMP_CREDIT, ";  //TODO2の箇所で使用
        $query .= "     SUM(W1.GET_CREDIT) AS GET_CREDIT ";     //TODO2の箇所で使用
        $query .= " FROM ";
        $query .= "     RECORD_SCORE_DAT W1 ";
        $query .= "     INNER JOIN T_SCHREG W2 ON W2.SCHREGNO = W1.SCHREGNO ";
        $query .= "     LEFT JOIN SUPP_EXA_SDIV_DAT W3 ON W3.YEAR = W1.YEAR ";
        $query .= "             AND W3.SEMESTER = W1.SEMESTER ";
        $query .= "             AND W3.TESTKINDCD = W1.TESTKINDCD ";
        $query .= "             AND W3.TESTITEMCD = W1.TESTITEMCD ";
        $query .= "             AND W3.SCORE_DIV = W1.SCORE_DIV ";
        $query .= "             AND W3.CLASSCD = W1.CLASSCD ";
        $query .= "             AND W3.SCHOOL_KIND = W1.SCHOOL_KIND ";
        $query .= "             AND W3.CURRICULUM_CD = W1.CURRICULUM_CD ";
        $query .= "             AND W3.SUBCLASSCD = W1.SUBCLASSCD ";
        $query .= "             AND W3.SCHREGNO = W1.SCHREGNO ";
        $query .= "             AND W3.SCORE_FLG = '2' ";
        $query .= " WHERE ";
        $query .= "     W1.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND W1.SCHOOL_KIND = '{$model->school_kind}' ";
        $query .= "     AND W1.SEMESTER || W1.TESTKINDCD || W1.TESTITEMCD || W1.SCORE_DIV <= '{$testcd}' ";
        $query .= "     AND W1.SCORE_DIV = '08' ";
        $query .= "     AND W1.TESTKINDCD || W1.TESTITEMCD NOT IN ('9900') ";
        $query .= " GROUP BY ";
        $query .= "     W1.CLASSCD, ";
        $query .= "     W1.SCHOOL_KIND, ";
        $query .= "     W1.CURRICULUM_CD, ";
        $query .= "     W1.SUBCLASSCD, ";
        $query .= "     W1.SCHREGNO, ";
        $query .= "     W1.SEMESTER || W1.TESTKINDCD || W1.TESTITEMCD || W1.SCORE_DIV ";
        return $query;
    }

    //(SCOREがNULL)かつ(VALUE_DIが*)の学籍番号を取得するクエリー
    function getRecordNullRuikeiQuery($model, $div) {
        $query  = "";
        $query .= "    SELECT ";
        $query .= "        TESTCD, ";
        $query .= "        T1.SCHREGNO ";
        $query .= "    FROM ";
        $query .= "        T_SCORE_RUIKEI T1 ";
        $query .= "    WHERE ";
        if ($model->z010 == 'bunkyo') {
           $query .= "        (T1.VALUE_DI = '*' OR T1.SCORE IS NULL) ";
        } else {
           $query .= "        T1.VALUE_DI = '*' ";
        }
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        //３科目・５科目
        if ($div != "9" && $div != "8" && $div != "7") {
            $query .= " AND EXISTS( ";
            $query .= "        SELECT ";
            $query .= "            'X' ";
            $query .= "        FROM ";
            $query .= "            T_GROUP W1 ";
            $query .= "        WHERE ";
            $query .= "            W1.GROUP_DIV = '".$div."' AND ";
            $query .= "            W1.SCHREGNO = T1.SCHREGNO AND ";
            $query .= "            W1.CLASSCD = T1.CLASSCD AND ";
            $query .= "            W1.SCHOOL_KIND = T1.SCHOOL_KIND AND ";
            $query .= "            W1.CURRICULUM_CD = T1.CURRICULUM_CD AND ";
            $query .= "            W1.SUBCLASSCD = T1.SUBCLASSCD ";
            $query .= "        ) ";
        //全科目
        } else {
            //888888：選択科目
            if ($div == "8") {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD     in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO ) ";
            }
            //777777：必修科目　（つまり、選択科目を除く）
            if ($div == "7") {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO ) ";
            }
            //教科科目名称マスタのマスタ化
            if ($model->Properties["useClassDetailDat"] == '1') {
                $query .= " AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
            } else {
                //名称マスタ「D017」NAME1に登録されている科目を除く。
                $query .= " AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
            }
            //教科９０以上は除く。つまり、教科９０未満が対象
            $query .= " AND T1.SUBCLASSCD not like '9%' ";
            //「学年末」の場合、履修単位・修得単位の両方 NULL が対象・・・TODO2
            if ($model->seme == "9") {
                $query .= " AND T1.COMP_CREDIT IS NULL ";
                $query .= " AND T1.GET_CREDIT IS NULL ";
            }
        }
        $query .= "    GROUP BY T1.TESTCD, T1.SCHREGNO ";
        return $query;
    }

    //各生徒の３科目・５科目・全科目のSCOREの合計を取得するクエリー
    function getRecordScoreSumQuery($model) {
        $testcd = $model->seme . $model->kind . $model->item . $model->sdiv;

        $query  = "";
        $query .= "    SELECT  ";
        $query .= "        '33' as CLASSCD, ";
        $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
        $query .= "        '99' as CURRICULUM_CD, ";
        $query .= "        '333333' as SUBCLASSCD, ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
        $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
        $query .= "        SUM(T1.SCORE) AS SCORE ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        $query .= "        EXISTS( ";
        $query .= "            SELECT ";
        $query .= "                'X' ";
        $query .= "            FROM ";
        $query .= "                T_GROUP W1 ";
        $query .= "            WHERE ";
        $query .= "                W1.GROUP_DIV = '3' AND ";
        $query .= "                W1.SCHREGNO = T1.SCHREGNO AND ";
        $query .= "                W1.CLASSCD = T1.CLASSCD AND ";
        $query .= "                W1.SCHOOL_KIND = T1.SCHOOL_KIND AND ";
        $query .= "                W1.CURRICULUM_CD = T1.CURRICULUM_CD AND ";
        $query .= "                W1.SUBCLASSCD = T1.SUBCLASSCD ";
        $query .= "            ) AND ";
        $query .= "        T1.SCORE IS NOT NULL ";
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        $query .= "    GROUP BY T1.SCHREGNO ";
        $query .= "    UNION ALL ";
        $query .= "    SELECT  ";
        $query .= "        '55' as CLASSCD, ";
        $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
        $query .= "        '99' as CURRICULUM_CD, ";
        $query .= "        '555555' as SUBCLASSCD, ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
        $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
        $query .= "        SUM(T1.SCORE) AS SCORE ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        $query .= "        EXISTS( ";
        $query .= "            SELECT ";
        $query .= "                'X' ";
        $query .= "            FROM ";
        $query .= "                T_GROUP W1 ";
        $query .= "            WHERE ";
        $query .= "                W1.GROUP_DIV = '5' AND ";
        $query .= "                W1.SCHREGNO = T1.SCHREGNO AND ";
        $query .= "                W1.CLASSCD = T1.CLASSCD AND ";
        $query .= "                W1.SCHOOL_KIND = T1.SCHOOL_KIND AND ";
        $query .= "                W1.CURRICULUM_CD = T1.CURRICULUM_CD AND ";
        $query .= "                W1.SUBCLASSCD = T1.SUBCLASSCD ";
        $query .= "            ) AND ";
        $query .= "        T1.SCORE IS NOT NULL ";
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        $query .= "    GROUP BY T1.SCHREGNO ";
        $query .= "    UNION ALL ";
        $query .= "    SELECT  ";
        $query .= "        '99' as CLASSCD, ";
        $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
        $query .= "        '99' as CURRICULUM_CD, ";
        $query .= "        '999999' as SUBCLASSCD, ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
        $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
        $query .= "        SUM(T1.SCORE) AS SCORE ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        $query .= "        T1.SCORE IS NOT NULL ";
        //教科科目名称マスタのマスタ化
        if ($model->Properties["useClassDetailDat"] == '1') {
            $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
        } else {
            //名称マスタ「D017」NAME1に登録されている科目を除く。
            $query .= "     AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
        }
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        $query .= "    GROUP BY T1.SCHREGNO ";

        $query .= "    UNION ALL ";
        $query .= "    SELECT  ";
        $query .= "        '88' as CLASSCD, ";
        $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
        $query .= "        '99' as CURRICULUM_CD, ";
        $query .= "        '888888' as SUBCLASSCD, ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
        $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
        $query .= "        SUM(T1.SCORE) AS SCORE ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        $query .= "        T1.SCORE IS NOT NULL ";
        //888888：選択科目
        $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO) ";
        //教科科目名称マスタのマスタ化
        if ($model->Properties["useClassDetailDat"] == '1') {
            $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
        } else {
            //名称マスタ「D017」NAME1に登録されている科目を除く。
            $query .= "     AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
        }
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        $query .= "    GROUP BY T1.SCHREGNO ";

        $query .= "    UNION ALL ";
        $query .= "    SELECT  ";
        $query .= "        '77' as CLASSCD, ";
        $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
        $query .= "        '99' as CURRICULUM_CD, ";
        $query .= "        '777777' as SUBCLASSCD, ";
        $query .= "        T1.SCHREGNO, ";
        $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
        $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
        $query .= "        SUM(T1.SCORE) AS SCORE ";
        $query .= "    FROM ";
        $query .= "        T_SCORE T1 ";
        $query .= "    WHERE ";
        $query .= "        T1.SCORE IS NOT NULL ";
        //777777：必修科目　（つまり、選択科目を除く）
        $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO) ";
        //教科科目名称マスタのマスタ化
        if ($model->Properties["useClassDetailDat"] == '1') {
            $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
        } else {
            //名称マスタ「D017」NAME1に登録されている科目を除く。
            $query .= "     AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
        }
        //FI対応
        if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
            $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
            $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        } else {
            $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
            $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
            $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
            $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
        }
        $query .= "    GROUP BY T1.SCHREGNO ";

        return $query;
    }

    //各生徒の３科目・５科目・全科目のSCOREの合計を取得するクエリー
    function getRecordScoreSumRuikeiQuery($model) {
        $testcd = $model->seme . $model->kind . $model->item . $model->sdiv;

        $query  = "";
        $unionall = "";
        $divs = array("3", "5", "9", "8", "7");
        foreach ($divs as $div) {
            $classcd = $div.$div;
            $subclasscd = $div.$div.$div.$div.$div.$div;

            $query .= $unionall;
            $query .= "    SELECT  ";
            $query .= "        TESTCD, ";
            $query .= "        '{$classcd}' as CLASSCD, ";
            $query .= "        max(T1.SCHOOL_KIND) as SCHOOL_KIND, ";
            $query .= "        '99' as CURRICULUM_CD, ";
            $query .= "        '{$subclasscd}' as SUBCLASSCD, ";
            $query .= "        T1.SCHREGNO, ";
            $query .= "        DECIMAL(ROUND(AVG(FLOAT(T1.SCORE))*100000,0)/100000,9,5) AS AVG, ";
            $query .= "        SUM(CASE WHEN T1.SCORE IS NOT NULL THEN 1 ELSE 0 END) AS SCORE_CNT, ";
            $query .= "        SUM(T1.SCORE) AS SCORE ";
            $query .= "    FROM ";
            $query .= "        T_SCORE_RUIKEI T1 ";
            $query .= "    WHERE ";
            $query .= "        T1.SCORE IS NOT NULL ";

            if ($div == "7") {
                //777777：必修科目　（つまり、選択科目を除く）
                $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO) ";
            } else if ($div == "8") {
                //888888：選択科目
                $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM T_SELECT_SUBCLASS W2 WHERE W2.SCHREGNO = T1.SCHREGNO) ";
            }
            if ($div == "9" || $div == "8" || $div == "7") {
                //教科科目名称マスタのマスタ化
                if ($model->Properties["useClassDetailDat"] == '1') {
                    $query .= "     AND T1.CLASSCD || T1.SCHOOL_KIND || T1.CURRICULUM_CD || T1.SUBCLASSCD not in (SELECT W2.CLASSCD || W2.SCHOOL_KIND || W2.CURRICULUM_CD || W2.SUBCLASSCD FROM SUBCLASS_DETAIL_DAT W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.SUBCLASS_SEQ = '004') ";
                } else {
                    //名称マスタ「D017」NAME1に登録されている科目を除く。
                    $query .= "     AND T1.SUBCLASSCD not in (SELECT W2.NAME1 FROM V_NAME_MST W2 WHERE W2.YEAR = '".CTRL_YEAR."' AND W2.NAMECD1 = 'D017') ";
                }
            } else {
                $query .= "        AND EXISTS( ";
                $query .= "            SELECT ";
                $query .= "                'X' ";
                $query .= "            FROM ";
                $query .= "                T_GROUP W1 ";
                $query .= "            WHERE ";
                $query .= "                W1.GROUP_DIV = '{$div}' AND ";
                $query .= "                W1.SCHREGNO = T1.SCHREGNO AND ";
                $query .= "                W1.CLASSCD = T1.CLASSCD AND ";
                $query .= "                W1.SCHOOL_KIND = T1.SCHOOL_KIND AND ";
                $query .= "                W1.CURRICULUM_CD = T1.CURRICULUM_CD AND ";
                $query .= "                W1.SUBCLASSCD = T1.SUBCLASSCD ";
                $query .= "            ) ";
            }
            //FI対応
            if ($model->Properties["useFi_Hrclass"] != '1' || $testcd == '9990009') {
                $query .= "        AND NOT EXISTS (SELECT 'X' FROM SUBCLASS_REPLACE_COMBINED_DAT ";
                $query .= "               WHERE YEAR = '".CTRL_YEAR."' ";
                $query .= "                 AND ATTEND_CLASSCD = T1.CLASSCD ";
                $query .= "                 AND ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
                $query .= "                 AND ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
                $query .= "                 AND ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
            } else {
                $query .= "        AND NOT EXISTS (SELECT 'X' FROM T_WEIGHTING W1 ";
                $query .= "               WHERE W1.SCHREGNO = T1.SCHREGNO ";
                $query .= "                 AND W1.ATTEND_CLASSCD = T1.CLASSCD ";
                $query .= "                 AND W1.ATTEND_SCHOOL_KIND = T1.SCHOOL_KIND ";
                $query .= "                 AND W1.ATTEND_CURRICULUM_CD = T1.CURRICULUM_CD ";
                $query .= "                 AND W1.ATTEND_SUBCLASSCD = T1.SUBCLASSCD) ";
            }
            $query .= "    GROUP BY T1.TESTCD, T1.SCHREGNO ";
            $unionall = " UNION ALL ";

        }

        return $query;
    }

    //成績平均データクエリー
    function getRecordAverageQuery($model, $table) {
        $field_name  = ($table == "record_rank_chair") ? "CHAIRCD," : "";
        $table_name  = ($table == "record_rank_chair") ? "record_average_chair" : "record_average";
        $query  = "";
        $query .= "    SELECT ";
        $query .= "        CLASSCD, ";
        $query .= "        SCHOOL_KIND, ";
        $query .= "        CURRICULUM_CD, ";
        $query .= "        SUBCLASSCD, ";
        $query .= $field_name;
        $query .= "        AVG_DIV, ";
        $query .= "        GRADE, ";
        $query .= "        HR_CLASS, ";
        $query .= "        COURSECD||MAJORCD||COURSECODE AS COURSE, ";
        $query .= "        MAJORCD AS MAJOR, ";
        $query .= "        DECIMAL(ROUND(FLOAT(AVG)*10,0)/10,5,1) AS AVG,STDDEV ";
        $query .= "    FROM ";
        $query .= $table_name .$model->tableStr;
        $query .= "    WHERE ";
        $query .= "        YEAR = '".CTRL_YEAR."' AND ";
        $query .= "        SEMESTER = '".$model->seme."' AND ";
        $query .= "        TESTKINDCD = '".$model->kind."' AND ";
        $query .= "        TESTITEMCD = '".$model->item."' AND ";
        $query .= "        SCORE_DIV = '".$model->sdiv."' AND ";
        $query .= "        GRADE = '".$model->grade."' ";
        return $query;
    }

    //在籍&成績２クエリー
    function getRecordSchregQuery($model, $table) {
        $query  = "";
        $query .= "    SELECT ";
        $query .= "        W1.CLASSCD, ";
        $query .= "        W1.SCHOOL_KIND, ";
        $query .= "        W1.CURRICULUM_CD, ";
        $query .= "        W1.SUBCLASSCD, ";
        $query .= "        W1.SCHREGNO, ";
        $query .= "        SCORE, ";
        $query .= "        cast(null as decimal) as AVG, ";
        $query .= "        GRADE, ";
        $query .= "        HR_CLASS, ";
        $query .= "        COURSECD,MAJORCD,COURSECODE, ";
        $query .= "        COURSE, ";
        $query .= "        MAJOR ";
        $query .= "    FROM ";
        $query .= "        T_SCORE W1, ";
        $query .= "        T_SCHREG W2 ";
        $query .= "    WHERE ";
        $query .= "        W1.SCHREGNO = W2.SCHREGNO AND ";
        $query .= "        SCORE IS NOT NULL ";
        if ($table == "record_average" || $table == "record_rank") {
            $query .= "    UNION ALL ";
            $query .= "    SELECT ";
            $query .= "        W1.CLASSCD, ";
            $query .= "        W1.SCHOOL_KIND, ";
            $query .= "        W1.CURRICULUM_CD, ";
            $query .= "        W1.SUBCLASSCD, ";
            $query .= "        W1.SCHREGNO, ";
            $query .= "        SCORE, ";
            $query .= "        AVG, ";
            $query .= "        GRADE, ";
            $query .= "        HR_CLASS, ";
            $query .= "        COURSECD,MAJORCD,COURSECODE, ";
            $query .= "        COURSE, ";
            $query .= "        MAJOR ";
            $query .= "    FROM ";
            $query .= "        T_SCORE_SUM W1, ";
            $query .= "        T_SCHREG W2 ";
            $query .= "    WHERE ";
            $query .= "        W1.SCHREGNO = W2.SCHREGNO ";
            $query .= "     AND ( ";
            $query .= "         (W1.SUBCLASSCD  = '333333' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL3 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '555555' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL5 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '999999' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL  W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '888888' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL8 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '777777' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL7 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "         ) ";
        }
        return $query;
    }

    //在籍&成績２クエリー
    function getRecordSchregRuikeiQuery($model, $table) {
        $query  = "";
        $query .= "    SELECT ";
        $query .= "        W1.TESTCD, ";
        $query .= "        W1.CLASSCD, ";
        $query .= "        W1.SCHOOL_KIND, ";
        $query .= "        W1.CURRICULUM_CD, ";
        $query .= "        W1.SUBCLASSCD, ";
        $query .= "        W1.SCHREGNO, ";
        $query .= "        SCORE, ";
        $query .= "        cast(null as decimal) as AVG, ";
        $query .= "        GRADE, ";
        $query .= "        HR_CLASS, ";
        $query .= "        COURSECD,MAJORCD,COURSECODE, ";
        $query .= "        COURSE, ";
        $query .= "        MAJOR ";
        $query .= "    FROM ";
        $query .= "        T_SCORE_RUIKEI W1, ";
        $query .= "        T_SCHREG W2 ";
        $query .= "    WHERE ";
        $query .= "        W1.SCHREGNO = W2.SCHREGNO AND ";
        $query .= "        SCORE IS NOT NULL ";
        if ($table == "record_average" || $table == "record_rank") {
            $query .= "    UNION ALL ";
            $query .= "    SELECT ";
            $query .= "        W1.TESTCD, ";
            $query .= "        W1.CLASSCD, ";
            $query .= "        W1.SCHOOL_KIND, ";
            $query .= "        W1.CURRICULUM_CD, ";
            $query .= "        W1.SUBCLASSCD, ";
            $query .= "        W1.SCHREGNO, ";
            $query .= "        SCORE, ";
            $query .= "        AVG, ";
            $query .= "        GRADE, ";
            $query .= "        HR_CLASS, ";
            $query .= "        COURSECD,MAJORCD,COURSECODE, ";
            $query .= "        COURSE, ";
            $query .= "        MAJOR ";
            $query .= "    FROM ";
            $query .= "        T_SCORE_SUM_RUIKEI W1, ";
            $query .= "        T_SCHREG W2 ";
            $query .= "    WHERE ";
            $query .= "        W1.SCHREGNO = W2.SCHREGNO ";
            $query .= "     AND ( ";
            $query .= "         (W1.SUBCLASSCD  = '333333' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL_RUIKEI3 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '555555' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL_RUIKEI5 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '999999' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL_RUIKEI  W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '888888' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL_RUIKEI8 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "      OR (W1.SUBCLASSCD  = '777777' AND NOT EXISTS(SELECT 'X' FROM T_SCORE_NULL_RUIKEI7 W3 WHERE W3.SCHREGNO = W2.SCHREGNO)) ";
            $query .= "         ) ";
        }
        return $query;
    }

    //成績平均データの追加クエリー
    function getInsertAverageQuery($model, $table) {
        $field_name  = ($table == "record_average_chair") ? "CHAIRCD," : "";
        $table_name  = ($table == "record_average_chair") ? "_CHAIR" : "";
        $query  = "";
        //学年
        $query .= "SELECT ";
        $query .= "    T1.CLASSCD, ";
        $query .= "    T1.SCHOOL_KIND, ";
        $query .= "    T1.CURRICULUM_CD, ";
        $query .= "    T1.SUBCLASSCD, ";
        $query .= $field_name;
        $query .= "    T1.AVG_DIV, ";
        $query .= "    T1.GRADE, ";
        $query .= "    T1.HR_CLASS, ";
        $query .= "    T1.COURSECD, ";
        $query .= "    T1.MAJORCD, ";
        $query .= "    T1.COURSECODE, ";
        $query .= "    T1.SCORE, ";
        $query .= "    T1.HIGHSCORE, ";
        $query .= "    T1.LOWSCORE, ";
        $query .= "    T1.COUNT, ";
        if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
            $query .= "    T2.AVG, ";
        } else {
            $query .= "    T1.AVG, ";
        }
        $query .= "    STDDEV ";
        $query .= "FROM ";
        $query .= "    T_MAIN T1 ";
        if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
            $query .= "    INNER JOIN ( ";
            $query .= "                SELECT ";
            $query .= "                   T2.CLASSCD ,T2.SCHOOL_KIND ,T2.CURRICULUM_CD ,T2.SUBCLASSCD ,T2.AVG_DIV ";
            $query .= "                  ,T2.GRADE ,T2.HR_CLASS ,T2.COURSECD ,T2.MAJORCD ,T2.COURSECODE ";
            $query .= "                  ,SUM(T2.AVG) AS AVG ";
            $query .= "                FROM T_RUIKEI_MAIN T2 ";
            $query .= "                GROUP BY ";
            $query .= "                   T2.CLASSCD ,T2.SCHOOL_KIND ,T2.CURRICULUM_CD ,T2.SUBCLASSCD ,T2.AVG_DIV ";
            $query .= "                  ,T2.GRADE ,T2.HR_CLASS ,T2.COURSECD ,T2.MAJORCD ,T2.COURSECODE ";
            $query .= "               ) T2 ON T2.CLASSCD = T1.CLASSCD ";
            $query .= "                   AND T2.SCHOOL_KIND = T1.SCHOOL_KIND ";
            $query .= "                   AND T2.CURRICULUM_CD = T1.CURRICULUM_CD ";
            $query .= "                   AND T2.SUBCLASSCD = T1.SUBCLASSCD ";
            $query .= "                   AND T2.AVG_DIV = T1.AVG_DIV ";
            $query .= "                   AND T2.GRADE = T1.GRADE ";
            $query .= "                   AND T2.HR_CLASS = T1.HR_CLASS ";
            $query .= "                   AND T2.COURSECD = T1.COURSECD ";
            $query .= "                   AND T2.MAJORCD = T1.MAJORCD ";
            $query .= "                   AND T2.COURSECODE = T1.COURSECODE ";
        }
        return $query;
    }//getInsertAverageQuery

    //成績平均データの追加クエリー
    function getAverageMain($model, $table) {
        $field_name  = ($table == "record_average_chair") ? "CHAIRCD," : "";
        $table_name  = ($table == "record_average_chair") ? "_CHAIR" : "";
        $query  = "";

        $avgDivs = array("1", "2", "3", "5");
        $unionAll = "";
        foreach ($avgDivs as $avgDiv) {
            //学年
            $query .= $unionAll;
            $query .= "SELECT ";
            $query .= "    CLASSCD, ";
            $query .= "    SCHOOL_KIND, ";
            $query .= "    CURRICULUM_CD, ";
            $query .= "    SUBCLASSCD, ";
            $query .= $field_name;
            $query .= "    '{$avgDiv}' as AVG_DIV, ";
            $query .= "    GRADE, ";
            if ($avgDiv == "1") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    '000' as MAJORCD, ";
                $query .= "    '0000' as COURSECODE, ";
            } else if ($avgDiv == "2") {
                $query .= "    HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    '000' as MAJORCD, ";
                $query .= "    '0000' as COURSECODE, ";
            } else if ($avgDiv == "3") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    COURSECD, ";
                $query .= "    MAJORCD, ";
                $query .= "    COURSECODE, ";
            } else if ($avgDiv == "5") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    MAJOR as MAJORCD, ";
                $query .= "    '0000' AS COURSECODE, ";
            } 
            $query .= "    SUM(SCORE) AS SCORE, ";
            $query .= "    MAX(SCORE) AS HIGHSCORE, ";
            $query .= "    MIN(SCORE) AS LOWSCORE, ";
            $query .= "    COUNT(SCHREGNO) AS COUNT, ";
            $query .= "    DECIMAL(ROUND(AVG(FLOAT(SCORE))*100000,0)/100000,9,5) AS AVG, ";
            $query .= "    DECIMAL(ROUND(STDDEV(FLOAT(SCORE))*10,0)/10,5,1) AS STDDEV ";
            $query .= "FROM ";
            $query .= "    T_RANK" .$table_name ." ";
            //処理科目(総合計のみ)
            if ($model->subclasscd == '999999') {
                $query .= "  WHERE SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
            //処理科目(各科目のみ)
            } else if ($model->subclasscd != '') {
                $query .= "  WHERE CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD = '".$model->subclasscd."' ";
            }
            $query .= "GROUP BY ";
            $query .= "    CLASSCD, ";
            $query .= "    SCHOOL_KIND, ";
            $query .= "    CURRICULUM_CD, ";
            $query .= "    SUBCLASSCD, ";
            $query .= $field_name;
            $query .= "    GRADE ";
            if ($avgDiv == "2") {
                $query .= "   ,HR_CLASS ";
            } else if ($avgDiv == "3") {
                $query .= "   ,COURSECD ";
                $query .= "   ,MAJORCD ";
                $query .= "   ,COURSECODE ";
            } else if ($avgDiv == "5") {
                $query .= "   ,MAJOR ";
            }
            //クラス
            $unionAll = "UNION ALL ";
        }
        return $query;
    }//getAverageMain

    //成績平均データの追加クエリー
    function getAverageRuikeiMain($model, $table) {
        $query  = "";

        $avgDivs = array("1", "2", "3", "5");
        $unionAll = "";
        foreach ($avgDivs as $avgDiv) {
            //学年
            $query .= $unionAll;
            $query .= "SELECT ";
            $query .= "    TESTCD, ";
            $query .= "    CLASSCD, ";
            $query .= "    SCHOOL_KIND, ";
            $query .= "    CURRICULUM_CD, ";
            $query .= "    SUBCLASSCD, ";
            $query .= "    '{$avgDiv}' as AVG_DIV, ";
            $query .= "    GRADE, ";
            if ($avgDiv == "1") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    '000' as MAJORCD, ";
                $query .= "    '0000' as COURSECODE, ";
            } else if ($avgDiv == "2") {
                $query .= "    HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    '000' as MAJORCD, ";
                $query .= "    '0000' as COURSECODE, ";
            } else if ($avgDiv == "3") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    COURSECD, ";
                $query .= "    MAJORCD, ";
                $query .= "    COURSECODE, ";
            } else if ($avgDiv == "5") {
                $query .= "    '000' as HR_CLASS, ";
                $query .= "    '0' as COURSECD, ";
                $query .= "    MAJOR as MAJORCD, ";
                $query .= "    '0000' AS COURSECODE, ";
            } 
            $query .= "    DECIMAL(ROUND(AVG(FLOAT(SCORE))*100000,0)/100000,9,5) AS AVG ";
            $query .= "FROM ";
            $query .= "    T_RANK_RUIKEI ";
            //処理科目(総合計のみ)
            if ($model->subclasscd == '999999') {
                $query .= "  WHERE SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
            //処理科目(各科目のみ)
            } else if ($model->subclasscd != '') {
                $query .= "  WHERE CLASSCD || '-' || SCHOOL_KIND || '-' || CURRICULUM_CD || '-' || SUBCLASSCD = '".$model->subclasscd."' ";
            }
            $query .= "GROUP BY ";
            $query .= "    TESTCD, ";
            $query .= "    CLASSCD, ";
            $query .= "    SCHOOL_KIND, ";
            $query .= "    CURRICULUM_CD, ";
            $query .= "    SUBCLASSCD, ";
            $query .= "    GRADE ";
            if ($avgDiv == "2") {
                $query .= "   ,HR_CLASS ";
            } else if ($avgDiv == "3") {
                $query .= "   ,COURSECD ";
                $query .= "   ,MAJORCD ";
                $query .= "   ,COURSECODE ";
            } else if ($avgDiv == "5") {
                $query .= "   ,MAJOR ";
            }
            //クラス
            $unionAll = "UNION ALL ";
        }
        return $query;
    }//getAverageRuikeiMain

    //成績席次データの追加クエリー
    function getInsertRankQuery($model, $table) {
        $field_name  = $table_name  = $where_name2 = $where_name3 = $where_name4 = "";
        if ($table == "record_rank_chair") {
            $field_name  = "W1.CHAIRCD,";
            $table_name  = "_CHAIR";
            $where_name2 = "W2.CHAIRCD = W1.CHAIRCD AND ";
            $where_name3 = "W3.CHAIRCD = W1.CHAIRCD AND ";
            $where_name4 = "W4.CHAIRCD = W1.CHAIRCD AND ";
            $where_name5 = "W5.CHAIRCD = W1.CHAIRCD AND ";
        }
        $fieldCrc = $whereCrc2 = $whereCrc3 = $whereCrc4 = "";
        $fieldCrc   = "W1.CLASSCD, W1.SCHOOL_KIND, W1.CURRICULUM_CD, ";
        $whereCrc2  = "W2.CLASSCD = W1.CLASSCD AND W2.SCHOOL_KIND = W1.SCHOOL_KIND AND W2.CURRICULUM_CD = W1.CURRICULUM_CD AND ";
        $whereCrc3  = "W3.CLASSCD = W1.CLASSCD AND W3.SCHOOL_KIND = W1.SCHOOL_KIND AND W3.CURRICULUM_CD = W1.CURRICULUM_CD AND ";
        $whereCrc4  = "W4.CLASSCD = W1.CLASSCD AND W4.SCHOOL_KIND = W1.SCHOOL_KIND AND W4.CURRICULUM_CD = W1.CURRICULUM_CD AND ";
        $whereCrc5  = "W5.CLASSCD = W1.CLASSCD AND W5.SCHOOL_KIND = W1.SCHOOL_KIND AND W5.CURRICULUM_CD = W1.CURRICULUM_CD AND ";
        $query  = "";
        //各科目
        $query .= "SELECT ";
        $query .= "    {$fieldCrc}W1.SUBCLASSCD, ";
        $query .= $field_name;
        $query .= "    W1.SCHREGNO, ";
        $query .= "    W1.SCORE, ";
        $query .= "    W1.AVG, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.GRADE ORDER BY W1.SCORE DESC) AS GRADE_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.HR_CLASS ORDER BY W1.SCORE DESC) AS CLASS_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.COURSE ORDER BY W1.SCORE DESC) AS COURSE_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.MAJOR ORDER BY W1.SCORE DESC) AS MAJOR_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.GRADE ORDER BY W1.SCORE DESC) AS GRADE_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.HR_CLASS ORDER BY W1.SCORE DESC) AS CLASS_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.COURSE ORDER BY W1.SCORE DESC) AS COURSE_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.MAJOR ORDER BY W1.SCORE DESC) AS MAJOR_AVG_RANK, ";
        $query .= "    case when 0 < W2.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W2.AVG)/W2.STDDEV+50)*10,0)/10,5,1) end AS GRADE_DEVIATION, ";
        $query .= "    case when 0 < W3.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W3.AVG)/W3.STDDEV+50)*10,0)/10,5,1) end AS CLASS_DEVIATION, ";
        $query .= "    case when 0 < W4.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W4.AVG)/W4.STDDEV+50)*10,0)/10,5,1) end AS COURSE_DEVIATION, ";
        $query .= "    case when 0 < W5.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W5.AVG)/W5.STDDEV+50)*10,0)/10,5,1) end AS MAJOR_DEVIATION ";
        $query .= "FROM ";
        $query .= "    T_RANK" .$table_name ." W1 ";
        $query .= "    LEFT JOIN T_AVERAGE W2 ON W2.AVG_DIV = '1' AND {$whereCrc2}W2.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name2 ."W2.GRADE = W1.GRADE ";
        $query .= "    LEFT JOIN T_AVERAGE W3 ON W3.AVG_DIV = '2' AND {$whereCrc3}W3.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name3 ."W3.GRADE = W1.GRADE AND W3.HR_CLASS = W1.HR_CLASS ";
        $query .= "    LEFT JOIN T_AVERAGE W4 ON W4.AVG_DIV = '3' AND {$whereCrc4}W4.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name4 ."W4.GRADE = W1.GRADE AND W4.COURSE = W1.COURSE ";
        $query .= "    LEFT JOIN T_AVERAGE W5 ON W5.AVG_DIV = '5' AND {$whereCrc5}W5.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name5 ."W5.GRADE = W1.GRADE AND W5.MAJOR = W1.MAJOR ";
        $query .= "WHERE ";
        $query .= "    W1.SUBCLASSCD not in ('333333','555555','999999','888888','777777') ";
        //処理科目(総合計のみ)
        if ($model->subclasscd == '999999') {
            $query .= "  and W1.SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
        //処理科目(各科目のみ)
        } else if ($model->subclasscd != '') {
            $query .= "  and W1.CLASSCD || '-' || W1.SCHOOL_KIND || '-' || W1.CURRICULUM_CD || '-' || W1.SUBCLASSCD = '".$model->subclasscd."' ";
        }
        //３科・５科・全科
        $query .= "UNION ALL ";
        $query .= "SELECT ";
        $query .= "    {$fieldCrc}W1.SUBCLASSCD, ";
        $query .= $field_name;
        $query .= "    W1.SCHREGNO, ";
        $query .= "    W1.SCORE, ";
        $query .= "    W1.AVG, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.GRADE ORDER BY W1.SCORE DESC) AS GRADE_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.HR_CLASS ORDER BY W1.SCORE DESC) AS CLASS_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.COURSE ORDER BY W1.SCORE DESC) AS COURSE_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.MAJOR ORDER BY W1.SCORE DESC) AS MAJOR_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.GRADE ORDER BY W1.AVG DESC) AS GRADE_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.HR_CLASS ORDER BY W1.AVG DESC) AS CLASS_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.COURSE ORDER BY W1.AVG DESC) AS COURSE_AVG_RANK, ";
        $query .= "    RANK() OVER(PARTITION BY {$fieldCrc}W1.SUBCLASSCD," .$field_name ."W1.MAJOR ORDER BY W1.AVG DESC) AS MAJOR_AVG_RANK, ";
        $query .= "    case when 0 < W2.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W2.AVG)/W2.STDDEV+50)*10,0)/10,5,1) end AS GRADE_DEVIATION, ";
        $query .= "    case when 0 < W3.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W3.AVG)/W3.STDDEV+50)*10,0)/10,5,1) end AS CLASS_DEVIATION, ";
        $query .= "    case when 0 < W4.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W4.AVG)/W4.STDDEV+50)*10,0)/10,5,1) end AS COURSE_DEVIATION, ";
        $query .= "    case when 0 < W5.STDDEV then DECIMAL(ROUND((10*(W1.SCORE-W5.AVG)/W5.STDDEV+50)*10,0)/10,5,1) end AS MAJOR_DEVIATION ";
        $query .= "FROM ";
        $query .= "    T_RANK" .$table_name ." W1 ";
        $query .= "    LEFT JOIN T_AVERAGE W2 ON W2.AVG_DIV = '1' AND {$whereCrc2}W2.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name2 ."W2.GRADE = W1.GRADE ";
        $query .= "    LEFT JOIN T_AVERAGE W3 ON W3.AVG_DIV = '2' AND {$whereCrc3}W3.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name3 ."W3.GRADE = W1.GRADE AND W3.HR_CLASS = W1.HR_CLASS ";
        $query .= "    LEFT JOIN T_AVERAGE W4 ON W4.AVG_DIV = '3' AND {$whereCrc4}W4.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name4 ."W4.GRADE = W1.GRADE AND W4.COURSE = W1.COURSE ";
        $query .= "    LEFT JOIN T_AVERAGE W5 ON W5.AVG_DIV = '5' AND {$whereCrc5}W5.SUBCLASSCD = W1.SUBCLASSCD AND " .$where_name5 ."W5.GRADE = W1.GRADE AND W5.MAJOR = W1.MAJOR ";
        $query .= "WHERE ";
        $query .= "    W1.SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
        //処理科目(総合計のみ)
        if ($model->subclasscd == '999999') {
            $query .= "  and W1.SUBCLASSCD in ('333333','555555','999999','888888','777777') ";
        //処理科目(各科目のみ)
        } else if ($model->subclasscd != '') {
            $query .= "  and W1.CLASSCD || '-' || W1.SCHOOL_KIND || '-' || W1.CURRICULUM_CD || '-' || W1.SUBCLASSCD = '".$model->subclasscd."' ";
        }
        return $query;
    }//getInsertRankQuery

    //科目別の処理の追加クエリー
    function getInsertSubclassQuery($model, $table) {
        $query  = "";
        //（共通）追加クエリー
        $query .= knjd210sQuery::getInsertCommonQuery($model, $table);

        if ($table == "record_average_chair" || $table == "record_rank_chair") {
            $query .= knjd210sQuery::getChairQuery($model);
        }

        //メイン
        if ($table == "record_average" || $table == "record_average_chair") {
            $query .= ",T_MAIN AS ( ";
            $query .= knjd210sQuery::getAverageMain($model, $table);
            $query .= " ) ";
            if ($model->Properties["useFi_Hrclass"] != '1' && $model->tableStr == "_ruikei_sdiv_dat") {
                $query .= ",T_RUIKEI_MAIN AS ( ";
                $query .= knjd210sQuery::getAverageRuikeiMain($model, $table);
                $query .= " ) ";
            }
            $query .= knjd210sQuery::getInsertAverageQuery($model, $table);

        } else if ($table == "record_rank" || $table == "record_rank_chair") {
            //成績平均データ
            $query .= ",T_AVERAGE AS ( ";
            $query .= knjd210sQuery::getRecordAverageQuery($model, $table);
            $query .= "    ) ";

            $query .= knjd210sQuery::getInsertRankQuery($model, $table);
        }
        return $query;
    }

    //講座クエリー
    function getChairQuery($model) {
        $fieldCrc = $whereCrc2 = "";
        $fieldCrc   = "W1.CLASSCD, W1.SCHOOL_KIND, W1.CURRICULUM_CD, ";
        $whereCrc2  = "W2.CLASSCD = W1.CLASSCD AND W2.SCHOOL_KIND = W1.SCHOOL_KIND AND W2.CURRICULUM_CD = W1.CURRICULUM_CD AND ";
        $query  = "";
        $query .= ",T_CHAIR AS ( ";
        $query .= "SELECT ";
        $query .= "    {$fieldCrc}W1.SUBCLASSCD, W2.CHAIRCD, W2.SCHREGNO ";
        $query .= "FROM ";
        $query .= "    CHAIR_DAT W1, ";
        $query .= "    CHAIR_STD_DAT W2 ";
        $query .= "WHERE ";
        $query .= "    W1.YEAR = '".CTRL_YEAR."' AND ";
        $query .= "    W2.YEAR = W1.YEAR AND ";
        $query .= "    W2.SEMESTER = W1.SEMESTER AND ";
        $query .= "    W2.CHAIRCD = W1.CHAIRCD AND ";
        $query .= "    '".str_replace("/", "-", $model->chairdate)."' BETWEEN W2.APPDATE AND W2.APPENDDATE ";
        $query .= "GROUP BY ";
        $query .= "    {$fieldCrc}W1.SUBCLASSCD, W2.CHAIRCD, W2.SCHREGNO ";
        $query .= ")  ";
        $query .= ",T_RANK_CHAIR AS ( ";
        $query .= "SELECT ";
        $query .= "    {$fieldCrc}W1.SUBCLASSCD, W2.CHAIRCD, W1.SCHREGNO, ";
        $query .= "    W1.SCORE, W1.AVG, ";
        $query .= "    W1.GRADE, W1.HR_CLASS, ";
        $query .= "    W1.COURSECD, W1.MAJORCD, W1.COURSECODE, ";
        $query .= "    W1.COURSE, ";
        $query .= "    W1.MAJOR ";
        $query .= "FROM ";
        $query .= "    T_RANK W1 ";
        $query .= "    INNER JOIN T_CHAIR W2 ON {$whereCrc2}W2.SUBCLASSCD=W1.SUBCLASSCD AND W2.SCHREGNO = W1.SCHREGNO ";
        $query .= ")  ";
        return $query;
    }

}
?>
