# kanji=漢字
# $Id: 1458350cebc66ca2ae4fd67804adea53b2968f65 $

KNJD210Q
序列確定処理
-----
学校：宮城県（全日制）
-----
・TESTITEM_MST_COUNTFLG_NEW_SDIV
・RECORD_RANK_SDIV_DAT

2013/07/18  1.KNJD210M(1.8)を元に新規作成。
            -- プログラムＩＤを変更
            2.パーツタイプの対応
            -- テーブルを変更(キー追加：SCORE_DIV)
            -- 成績フィールドを変更(RECORD_SCORE_DAT.SCORE参照。VALUE未使用)
            -- 欠席(RECORD_SCORE_DAT.VALUE_DIが*)がある生徒の合算科目(ALL9)のレコードは作成しない

2014/05/30  1.更新/削除等のログ取得機能を追加

2014/06/10  1.学科の順位・平均点生成を追加

2014/09/26  1.「前期科目」「後期科目＋通年科目」を母集団とする序列を追加
            -- ９９９９９Ａ：前期のみ科目
            -- ９９９９９Ｂ：後期のみ科目＋通年科目

2016/04/19  1.実行履歴追加
            -- RECORD_RANK_EXEC_SDIV_DAT
            -- 学年コンボ：SCHREG_REGD_GDAT参照に変更
            -- 種別コンボ：序列対象ありのみ表示に変更
            2.プロパティuseRankCourseGroup = 1の時、コースグループ別
            -- それ以外の時、学科別　の順位を算出する。
            -- COURSE_GROUP_CD_DAT

2016/04/25  1.洛南は合算科目の母集団から合併先科目を除く
            -- 名称マスタ「Z010」「00」NAME1 = 'rakunan'
            -- SUBCLASS_REPLACE_COMBINED_DAT

2016/06/29  1.処理科目コンボ追加

2016/09/19  1.学年、科目コンボ修正
            -- プロパティー「useSchool_KindField」とSCHOOLKINDを参照
            -- 科目コンボは、指定した学年の校種を参照

2016/09/26  1.各科目の'9990008'のRECORD_RANK_SDIV_DAT.AVGに「平均点」を保持しておく。
            -- プロパティー「showHeikinran」が１の時。駿台甲府要望

2016/11/29  1.プロパティー「use_school_detail_gcm_dat」が"1"の時の処理追加
            -- 新テーブル参照（管理者コントロール、テスト項目マスタ、実行履歴）
            -- 課程学科コンボ追加
            -- 指定された課程学科の生徒が対象
            -- RECORD_AVERAGE_SDIV_DATのAVG_DIVが"1"のデータをセットしない。
            -- RECORD_RANK_SDIV_DATのGRADE_XXXのデータをセットしない。
            2.以下の通り修正
            -- 1)プロパティー「useRankCourseGroupVersion2」が"1"の時、
            --     COURSE_GROUP_XXXにコースグループ順位などをセットする。
            --     MAJOR_XXXに学科順位などをセットする。
            -- 2)プロパティー「useRankCourseGroup」が"1"の時、
            --     MAJOR_XXXにコースグループ順位などをセットする。
            -- 3)上記以外の時、
            --     MAJOR_XXXに学科順位などをセットする。
            ※ record_rank_sdiv_dat.sql (1.2)
            ※ record_rank_chair_sdiv_dat.sql (1.2)

2017/03/29  1.東大阪は公欠(+)忌引(-)のマークも参照する

2017/05/09  1.プロパティ「useAvgRyousei = 1」の時、「寮生平均」を算出する。
            -- RECORD_AVERAGE_SDIV_DAT.AVG_DIV（6:寮生/下宿生）
            2.ADMIN_CONTROL_PRG_SCHOOLKIND_MSTを使って、校種を制御する。
            --プロパティー追加：use_prg_schoolkind

2017/05/10  1.RECORD_AVERAGE_SDIV_DAT.AVG_DIV（7:寮生/下宿生）に変更

2017/06/07  1.プロパティー「useRankChairGroup」が"1"の時、講座グループの序列を作成
            -- 参考：常磐（KNJD210P）
            ※ record_rank_sdiv_dat.sql (1.3)
            ※ record_rank_chair_sdiv_dat.sql (1.3)
            ※ rep-record_rank_sdiv_dat.sql (1.2)
            ※ rep-record_rank_chair_sdiv_dat.sql (1.2)

2017/06/22  1.偏差値順位(学年、クラス、コース、コースグループ、学科)生成を追加

2017/06/28  1.DBエラー対応。前回修正の不具合。

2017/06/29  1.合算科目の平均点算出は、満点マスタを参照するように変更
            -- (素点合計÷満点合計)×100＝平均点

2017/07/05  1.寮生の条件から2:下宿をカット

2017/08/28  1.プロパティー「knjd210v_notUsetSubclassCombo = 1」の時は、科目コンボは非表示
            -- 処理は、全科目を選択した状態で、処理する。
            ※ 宮城県要望

2017/09/05  1.科目別の相対評定マスタを作成する機能を追加
            -- プロパティー「knjd210v_useRelativeAssessCheckbox = 1」の時、
            -- 「評定マスタ作成」チェックボックスを表示する。
            ※ 成城要望

2017/09/07  1.前回の修正漏れ。
            -- 評定2の下限値(最小値)は、1点までとする。

2016/12/20  1.土佐塾は学年評価で合算科目の母集団から合併先科目を除く
            -- 名称マスタ「Z010」「00」NAME1 = 'tosa'
            -- SUBCLASS_REPLACE_COMBINED_DAT

2018/02/14  1.宮城県は学年評価・学年評定で合算科目の母集団から合併元科目を除く
            -- 名称マスタ「Z010」「00」NAME1 = 'miyagiken'
            -- SUBCLASS_REPLACE_COMBINED_DAT

2018/02/23  1.宮城県は合算科目の母集団から合併元科目を除く
            --前回修正の条件（学年評価・学年評定）をカットした

2018/03/02  1.宮城県は学年評価・学年評定で合算科目の母集団から合併元科目を除く
            -- 2018/02/23の修正をカット

2018/03/19  1.名称マスタ「D070」参照し、合算科目の母集団から除く
            -- NAME1：テストコード「9990009」
            -- NAMESPARE1：フラグ「1:合併元除く 2:合併先除く」

2018/05/23  1.プロパティー「useMikomiFlg = 1」の時、欠席者で見込点があれば序列処理に見込点を含める

2018/06/04  1.名称マスタ「D070」の仕様追加（2018/03/19の修正）
            -- 処理学年の校種で、参照する名称マスタを切替える。「DJ70」「DH70」など・・・
            -- ない時は、「D070」を参照する。
            -- 洛南および土佐塾は別仕様のため、この名称マスタを参照しない。
            ※成城からの要望

2018/06/05  1.合算科目の偏差値は、各科目の偏差値の平均を算出するように変更
            ※宮城県から指摘

2018/06/07  1.前回の修正
            -- 満点で偏差値計算を判別する。1人でも科目の満点が複数ある（異なる）場合、
            -- 合算科目の偏差値は、各科目の偏差値の平均を算出するように変更
            ※三重県から指摘

2018/06/27  1.2018/05/23 1.の修正をカット
            -- 茗溪は通知票、個人成績票には見込点数を印字しない。成績一覧に含める。

2018/07/11  1.科目別の相対評定マスタを作成する機能の不具合修正
            ※成城から指摘

2018/07/13  1.名称マスタ「D065」「NAME1」に登録されている科目を合算科目の母集団から除く
            ※埼玉栄から要望

2018/07/26  1.教科別評定平均値序列処理追加
            -- 処理科目(全て)、考査種別(X-99-00-09)を指定した時のみ実行
            -- record_rank_class_sdiv_dat.sql (rev.61436)
            -- record_average_class_sdiv_dat.sql (rev.61447)
            ※玉川聖学院から要望

2018/12/06  1.名称マスタ「D017」の指定に教育課程を追加

2019/07/16  1.knjd210vGroupSubclassNotTargetScoreNullが1の場合、科目グループ3科5科の科目が1つでも得点nullか*入力があれば序列の対象外とする

2019/08/14  1.プロパティー「useRankCourseGroupVersion2」が"2"の時、クラス別コースグループ順位の処理を追加
            --プロパティー「useRankCourseGroupVersion2」が"2"の時、平均点の最高点・最低点の処理を追加
            ※帝京大から要望

2019/11/19  1.基準点設定の処理を追加
            -- standard_score_dat.sql (rev.70685)
            ※桜花学園から要望

2019/11/29  1.プロパティー「record_score_detail_001」= 1 で、SCORE_DIV = 08の時は、小数点第5位の得点でランク付けする。

2019/12/12  1.基準点設定の処理を変更
            -- 基準点は、学年毎ではなくコース毎に算出するように変更
            -- standard_score_dat.sql (rev.71182)
            ※桜花学園から要望

2019/12/16  1.プロパティー「useRank_record_slump_sdiv_dat」= 1 で、SIDOU_INPUT_INF = 2:得点の時は、追指導で入力された得点で序列確定処理する

2019/12/20  1.基準点の算出修正(×0.6の前に小数第二位で四捨五入する。)

2020/05/14  1.プロパティー「useRecordRankDetail = 1」の時、RANK_DIV = B,C,D,E,Fの処理を追加
            -- プロパティー「useRecordRankDetail = 1」の時、AVG_DIV = B,C,D,E,Fの処理を追加
            -- record_rank_detail_sdiv_dat.sql (rev.74192)
            -- record_rank_chair_detail_sdiv_dat.sql (rev.74192)
            ※帝京中高から要望

2020/05/15  1.教科マスタ、科目マスタ、のYDATにある成績のみ対象とする。
            ※雲雀丘中学で問題視になった
            2.2019/08/14修正分を以下の通り変更
            ★ プロパティー「useRankCourseGroupVersion2 = 2」を
            -- プロパティー「useRecordRankDetail = 1」に変更
            ★ 区分「AVG_DIV = 8」を
            -- 区分「AVG_DIV = A」に変更
            ★ テーブル「RECORD_RANK_SDIV_DATのCOURSE_GROUP_CL_XXX」にセットするのをやめて、
            -- テーブル「RECORD_RANK_DETAIL_SDIV_DAT(RANK_DIV = A)」にセットするように変更

2020/07/02  1.2019/11/29修正(小数点第5位の得点でランク付けする)の処理条件を変更
            -- 名称マスタ「Z010」「00」NAME1 = 'nichi-ni'
            -- 中学は、SCORE_DIV = 08
            -- 高校は、SEMESTER = 9 AND SCORE_DIV = 08

2020/10/08  1.平均点の値の持ち方（平均点のある全テーブル対象）を以下の通り変更
            -- 修正前：小数点第6位を四捨五入して、小数点第5位まで登録する。
            -- 修正後：小数点第6位を四捨五入して、小数点第5位まで登録する。
            -- 　　　　但し、新プロパテイー（knjd210v_AvgDecimalPoint）の数値までを登録する。
            -- 　　　　よって、値+1　を四捨五入する。
            -- ※立命館慶祥は、新プロパテイー（knjd210v_AvgDecimalPoint = 1）を設定する。
            2.ソースコード整形

2020/11/05  1.プロパティー「knjd210v_deviationTotalRank = 1」の時、合算科目の偏差値は、各科目の偏差値の平均を算出
            2.プロパティー「knjd210v_deviationTotalRank = 1」の時、各科目の偏差値の合計を算出する処理を追加（RECORD_RANK_DETAIL_SDIV_DAT.RANK_DIV = G）
            ※日大二中高から要望

2020/11/06  1.処理速度改善
            -- (3分20秒) → (2分50秒)
            -- 日大二中高のテスト機で確認

2020/11/10  1.ソース整理
            2.処理速度改善
            -- (2分50秒) → (1分10秒)
            -- 日大二中高のテスト機で確認

2020/11/16  1.母集団が1人で標準偏差が0.0の場合、偏差値は50とする。

2020/11/17  1.奈良県で欠課時数超過した科目は生徒の合計点・平均点に得点を含めない

2020/11/20  1.コード自動整形

2020/12/20  1.プロパティーuse_CHAIR_GROUP_SDIV_DATが1の場合、講座グループはCHAIR_GROUP_DATの代わりにCHAIR_GROUP_SDIV_DATを使用する
            -- 島根県対応
            -- TESTKINDCD、TESTITEMCD、SCORE_DIVは指定考査の設定分を優先する。設定が無ければ00、00、00を使用する

2021/02/02  1.該当年度に「不登校傾向生徒」の登録がない場合は、対象から外す。
            -- テーブルSCHREG_SCHOOL_REFUSAL_DATの参照条件にログイン年度を追加

2021/02/25  1.島根県で講座グループが1桁の場合にDBエラーにならないよう修正

2021/03/05  1.RECORD_RANK_CLASS_SDIV_DAT、RECORD_AVERAGE_CLASS_SDIV_DATを990008でも作成する。

2021/03/07  1.日大二中高は標準偏差(RECORD_AVERAGE_SDIV_DAT.STDDEV)はdecimal(9,5)で算出・更新する
            2.日大二中高は偏差値算出時の平均点を下1桁で四捨五入しない
            3.日大二中高は合計点の型変換を追加（偏差値の10*(得点-平均点)/標準偏差の算出が桁落ちする現象への対応）

2021/03/08  1.RECORD_RANK_CLASS_SDIV_DAT、RECORD_AVERAGE_CLASS_SDIV_DATをどの考査でも作成する。

2021/03/22  1.基準点設定の処理をカット
            ※桜花学園から要望
