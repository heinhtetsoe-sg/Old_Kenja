<?php

require_once('for_php7.php');

class knjb212Query extends Query
{
    //CSV出力データ取得
    public function getCsvData($model)
    {
        $query  = " WITH STUDYREC AS ( ";
        $query .= "     SELECT ";
        $query .= "         T1.GRADE, ";
        $query .= "         T1.COURSECD, ";
        $query .= "         T1.MAJORCD, ";
        $query .= "         T1.COURSECODE, ";
        $query .= "         T2.CLASSCD, ";
        $query .= "         T2.SCHOOL_KIND, ";
        $query .= "         T2.CURRICULUM_CD, ";
        $query .= "         T2.SUBCLASSCD, ";
        $query .= "         COUNT(*) AS CNT ";
        $query .= "     FROM ";
        $query .= "         SCHREG_REGD_DAT T1, ";
        $query .= "         SCHREG_STUDYREC_DAT T2 ";
        $query .= "     WHERE ";
        $query .= "         T1.YEAR     = T2.YEAR AND ";
        $query .= "         T1.YEAR     = '".$model->field["YEAR"]."' AND ";
        $query .= "         T1.SCHREGNO = T2.SCHREGNO ";
        $query .= "     GROUP BY ";
        $query .= "         T1.GRADE, ";
        $query .= "         T1.COURSECD, ";
        $query .= "         T1.MAJORCD, ";
        $query .= "         T1.COURSECODE, ";
        $query .= "         T2.CLASSCD, ";
        $query .= "         T2.SCHOOL_KIND, ";
        $query .= "         T2.CURRICULUM_CD, ";
        $query .= "         T2.SUBCLASSCD ";
        $query .= " ), RECORD_SCORE AS ( ";
        $query .= "     SELECT ";
        $query .= "         T1.GRADE, ";
        $query .= "         T1.COURSECD, ";
        $query .= "         T1.MAJORCD, ";
        $query .= "         T1.COURSECODE, ";
        $query .= "         T2.CLASSCD, ";
        $query .= "         T2.SCHOOL_KIND, ";
        $query .= "         T2.CURRICULUM_CD, ";
        $query .= "         T2.SUBCLASSCD, ";
        $query .= "         COUNT(*) AS CNT ";
        $query .= "     FROM ";
        $query .= "         SCHREG_REGD_DAT T1, ";
        $query .= "         RECORD_SCORE_DAT T2 ";
        $query .= "     WHERE ";
        $query .= "         T1.YEAR     = T2.YEAR AND ";
        $query .= "         T1.YEAR     = '".$model->field["YEAR"]."' AND ";
        $query .= "         T1.SEMESTER = T2.SEMESTER AND ";
        $query .= "         T1.SCHREGNO = T2.SCHREGNO ";
        $query .= "     GROUP BY ";
        $query .= "         T1.GRADE, ";
        $query .= "         T1.COURSECD, ";
        $query .= "         T1.MAJORCD, ";
        $query .= "         T1.COURSECODE, ";
        $query .= "         T2.CLASSCD, ";
        $query .= "         T2.SCHOOL_KIND, ";
        $query .= "         T2.CURRICULUM_CD, ";
        $query .= "         T2.SUBCLASSCD ";
        $query .= " ) ";

        $query .= " SELECT ";
        $query .= "     T1.YEAR, ";
        $query .= "     T1.GRADE, ";
        $query .= "     T1.COURSECD, ";
        $query .= "     T1.MAJORCD, ";
        $query .= "     T1.COURSECODE, ";
        $query .= "     VALUE(T2.COURSENAME,'') || VALUE(T2.MAJORNAME,'') || VALUE(T3.COURSECODENAME,'') AS COURSENAME, ";
        $query .= "     T4.CLASSNAME, ";
        $query .= "     T1.CLASSCD || '-' || T1.SCHOOL_KIND || '-' || T1.CURRICULUM_CD || '-' || T1.SUBCLASSCD AS SUBCLASSCD, ";
        $query .= "     T5.SUBCLASSNAME, ";
        $query .= "     T5.SUBCLASSABBV, ";
        $query .= "     T1.CREDITS, ";
        $query .= "     L1.NAME1 AS REQUIRE_FLG_NAME, ";
        $query .= "     CASE WHEN L2.CNT > 0 THEN '有' ELSE '' END AS NINTEI, ";
        $query .= "     CASE WHEN L2.CNT > 0 THEN '有' ELSE '' END AS CHOSASHO, ";
        $query .= "     CASE WHEN L2.CNT > 0 THEN '有' ELSE '' END AS SHIDOYOROKU, ";
        $query .= "     CASE WHEN L3.CNT > 0 THEN '有' ELSE '' END AS TSUCHISHO, ";
        $query .= "     CASE WHEN L2.CNT > 0 THEN '有' ELSE '' END AS SHOMEISHO, ";
        $query .= "     CASE WHEN L2.CNT > 0 THEN '有' ELSE '' END AS SOGOGAKUSHU ";
        $query .= " FROM ";
        $query .= "     CREDIT_MST T1 ";
        $query .= "     LEFT JOIN V_NAME_MST L1 ";
        $query .= "             ON  T1.YEAR         = L1.YEAR ";
        $query .= "             AND L1.NAMECD1      = 'Z011' ";
        $query .= "             AND T1.REQUIRE_FLG  = L1.NAMECD2 ";
        $query .= "     LEFT JOIN STUDYREC L2 ";
        $query .= "             ON  T1.GRADE        = L2.GRADE ";
        $query .= "             AND T1.COURSECD     = L2.COURSECD ";
        $query .= "             AND T1.MAJORCD      = L2.MAJORCD ";
        $query .= "             AND T1.COURSECODE   = L2.COURSECODE ";
        $query .= "             AND T1.CLASSCD      = L2.CLASSCD ";
        $query .= "             AND T1.SCHOOL_KIND  = L2.SCHOOL_KIND ";
        $query .= "             AND T1.CURRICULUM_CD = L2.CURRICULUM_CD ";
        $query .= "             AND T1.SUBCLASSCD   = L2.SUBCLASSCD ";
        $query .= "     LEFT JOIN RECORD_SCORE L3 ";
        $query .= "             ON  T1.GRADE        = L3.GRADE ";
        $query .= "             AND T1.COURSECD     = L3.COURSECD ";
        $query .= "             AND T1.MAJORCD      = L3.MAJORCD ";
        $query .= "             AND T1.COURSECODE   = L3.COURSECODE ";
        $query .= "             AND T1.CLASSCD      = L3.CLASSCD ";
        $query .= "             AND T1.SCHOOL_KIND  = L3.SCHOOL_KIND ";
        $query .= "             AND T1.CURRICULUM_CD = L3.CURRICULUM_CD ";
        $query .= "             AND T1.SUBCLASSCD   = L3.SUBCLASSCD, ";
        $query .= "     V_COURSE_MAJOR_MST T2, ";
        $query .= "     V_COURSECODE_MST T3, ";
        $query .= "     V_CLASS_MST T4, ";
        $query .= "     V_SUBCLASS_MST T5 ";
        $query .= " WHERE ";
        $query .= "     T1.YEAR         = '".$model->field["YEAR"]."' AND ";
        $query .= "     T1.YEAR         = T2.YEAR AND ";
        $query .= "     T1.YEAR         = T3.YEAR AND ";
        $query .= "     T1.YEAR         = T4.YEAR AND ";
        $query .= "     T1.YEAR         = T5.YEAR AND ";
        $query .= "     T1.COURSECD     = T2.COURSECD AND ";
        $query .= "     T1.MAJORCD      = T2.MAJORCD AND ";
        $query .= "     T1.COURSECODE   = T3.COURSECODE AND ";
        $query .= "     T1.CLASSCD      = T4.CLASSCD AND ";
        $query .= "     T1.SCHOOL_KIND  = T4.SCHOOL_KIND AND ";
        $query .= "     T1.CLASSCD      = T5.CLASSCD AND ";
        $query .= "     T1.SCHOOL_KIND  = T5.SCHOOL_KIND AND ";
        $query .= "     T1.CURRICULUM_CD = T5.CURRICULUM_CD AND ";
        $query .= "     T1.SUBCLASSCD   = T5.SUBCLASSCD ";
        $query .= " ORDER BY ";
        $query .= "     T1.YEAR, ";
        $query .= "     T1.GRADE, ";
        $query .= "     T1.COURSECD, ";
        $query .= "     T1.MAJORCD, ";
        $query .= "     T1.COURSECODE, ";
        $query .= "     SUBCLASSCD ";

        return $query;
    }
}
