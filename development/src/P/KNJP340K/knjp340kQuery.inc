<?php

require_once('for_php7.php');

class knjp340kquery extends Query {

    //データ更新
    function updateAdjust($model)
    {
        $db = Query::dbCheckOut();
        $db->autoCommit(false);

        $query = "DELETE FROM REDUCTION_ADJUSTMENT_DAT WHERE YEAR = '".CTRL_YEAR."' ";
        $db->query($query);

        //相殺年月クリア
        $query  = " INSERT INTO REDUCTION_ADJUSTMENT_DAT ";
        $query .= " WITH MONEY_DUE_T AS ( ";
        $query .= " SELECT ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     L1.CURRICULUM_YEAR, ";
        $query .= "     SUM(T1.MONEY_DUE) / 4 AS MONEY_DUE1, ";
        $query .= "     SUM(T1.MONEY_DUE) / 4 * 3 AS MONEY_DUE2, ";
        $query .= "     SUM(T1.MONEY_DUE) AS MONEY_DUE ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_M_DAT T1 ";
        $query .= "     LEFT JOIN (SELECT DISTINCT ";
        $query .= "                  LT1.SCHREGNO, ";
        $query .= "                  LT1.CURRICULUM_YEAR ";
        $query .= "                FROM ";
        $query .= "                  SCHREG_ENT_GRD_HIST_DAT LT1, ";
        $query .= "                  (SELECT ";
        $query .= "                      I1.SCHREGNO, ";
        $query .= "                      I2.SCHOOL_KIND ";
        $query .= "                   FROM ";
        $query .= "                      SCHREG_REGD_DAT I1, ";
        $query .= "                      SCHREG_REGD_GDAT I2 ";
        $query .= "                   WHERE ";
        $query .= "                      I1.YEAR = '".CTRL_YEAR."' ";
        $query .= "                      AND I1.SEMESTER = '".CTRL_SEMESTER."' ";
        $query .= "                      AND I1.YEAR = I2.YEAR ";
        $query .= "                      AND I1.GRADE = I2.GRADE) LT2 ";
        $query .= "                WHERE ";
        $query .= "                  LT1.SCHREGNO = LT2.SCHREGNO ";
        $query .= "                  AND LT1.SCHOOL_KIND = LT2.SCHOOL_KIND ";
        $query .= "     ) L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= " WHERE ";
        $query .= "    T1.YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND T1.EXPENSE_M_CD IN ('11', '12', '13') ";
        $query .= " GROUP BY ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     L1.CURRICULUM_YEAR ";
        $query .= " ), MONEY_DUE_T_MAIN AS ( ";
        $query .= " SELECT ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE1 <= L4.REDUCTIONMONEY_1 ";
        $query .= "          THEN T1.MONEY_DUE1 ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS MONEY_DUE1, ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE1 <= L4.REDUCTIONMONEY_1 ";
        $query .= "          THEN '1' ";
        $query .= "          ELSE '0' ";
        $query .= "     END AS MONEY_DUE1_FLG, ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE2 <= L5.REDUCTIONMONEY_2 ";
        $query .= "          THEN T1.MONEY_DUE2 ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS MONEY_DUE2, ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE2 <= L5.REDUCTIONMONEY_2 ";
        $query .= "          THEN '1' ";
        $query .= "          ELSE '0' ";
        $query .= "     END AS MONEY_DUE2_FLG, ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE1 <= L4.REDUCTIONMONEY_1 ";
        $query .= "          THEN T1.MONEY_DUE1 ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN ((VALUE(T1.MONEY_DUE1, 0) + VALUE(T1.MONEY_DUE2, 0)) > (VALUE(L4.REDUCTIONMONEY_1, 0) + VALUE(L4.REDUCTIONMONEY_2, 0))) AND T1.MONEY_DUE2 <= L5.REDUCTIONMONEY_2 ";
        $query .= "          THEN T1.MONEY_DUE2 ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     AS MONEY_DUE ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_T T1 ";
        $query .= "     LEFT JOIN SCHREG_BASE_MST L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= "     INNER JOIN REDUCTION_DAT I1 ON I1.YEAR = '".CTRL_YEAR."' ";
        $query .= "           AND T1.SCHREGNO = I1.SCHREGNO ";
        $query .= "     LEFT JOIN ( ";
        $query .= "             SELECT ";
        $query .= "                 REG.SCHREGNO, ";
        $query .= "                 MAX(REG.GRADE) AS GRADE ";
        $query .= "             FROM ";
        $query .= "                 SCHREG_REGD_DAT REG ";
        $query .= "             WHERE ";
        $query .= "                 REG.YEAR = '".CTRL_YEAR."' ";
        $query .= "             GROUP BY ";
        $query .= "                 REG.SCHREGNO ";
        $query .= "     ) REGD ON T1.SCHREGNO = REGD.SCHREGNO ";
        $query .= "     LEFT JOIN REDUCTION_PREF_GRADE_MST PREF_GRADE ON PREF_GRADE.YEAR = '".CTRL_YEAR."' ";
        $query .= "          AND I1.PREFECTURESCD = PREF_GRADE.PREFECTURESCD ";
        $query .= "          AND REGD.GRADE = PREF_GRADE.GRADE ";
        $query .= "     LEFT JOIN REDUCTION_MAX_MONEY_DAT L4 ON L4.YEAR || '-' || L4.GRADE = ";
        $query .= "                                                        CASE WHEN ".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 > 3 ";
        $query .= "                                                             THEN CAST(FISCALYEAR(L1.ENT_DATE) + 2 AS VARCHAR(4)) || '-03' ";
        $query .= "                                                             ELSE '".CTRL_YEAR."-0' || CAST(".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 AS VARCHAR(4)) ";
        $query .= "                                                        END ";
        $query .= "          AND I1.PREFECTURESCD = L4.PREFECTURESCD ";
        $query .= "          AND I1.REDUC_RANK_1 = L4.RANK_DIV ";
        $query .= "          AND T1.MONEY_DUE1 <= L4.REDUCTIONMONEY_1 ";
        $query .= "     LEFT JOIN REDUCTION_MAX_MONEY_DAT L5 ON L5.YEAR || '-' || L5.GRADE = ";
        $query .= "                                                        CASE WHEN ".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 > 3 ";
        $query .= "                                                             THEN CAST(FISCALYEAR(L1.ENT_DATE) + 2 AS VARCHAR(4)) || '-03' ";
        $query .= "                                                             ELSE '".CTRL_YEAR."-0' || CAST(".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 AS VARCHAR(4)) ";
        $query .= "                                                        END ";
        $query .= "          AND I1.PREFECTURESCD = L5.PREFECTURESCD ";
        $query .= "          AND I1.REDUC_RANK_1 = L5.RANK_DIV ";
        $query .= "          AND T1.MONEY_DUE2 <= L5.REDUCTIONMONEY_2 ";
        $query .= "     WHERE ";
        $query .= "         L4.YEAR IS NOT NULL OR L5.YEAR IS NOT NULL ";
        $query .= " ), REDUC_T AS ( ";
        $query .= " SELECT ";
        $query .= "     SCHREGNO, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_1 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_1, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY1, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_2 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_2, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY2, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_1 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_1, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN REDUC_DEC_FLG_2 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_2, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY ";
        $query .= " FROM ";
        $query .= "     REDUCTION_DAT ";
        $query .= " WHERE ";
        $query .= "    YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND (REDUC_DEC_FLG_1 = '1' ";
        $query .= "         OR ";
        $query .= "         REDUC_DEC_FLG_2 = '1') ";
        $query .= " GROUP BY ";
        $query .= "     SCHREGNO ";
        $query .= " ), REDUC_COUNTRY_T AS ( ";
        $query .= " SELECT ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     SUM(CASE WHEN VALUE(T1.PLAN_CANCEL_FLG, '0') = '0' AND T1.PLAN_MONTH IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(T1.PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN VALUE(T1.ADD_PLAN_CANCEL_FLG, '0') = '0' AND T1.PLAN_MONTH IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(T1.ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTION_C_MONEY1, ";
        $query .= "     SUM(CASE WHEN VALUE(T1.PLAN_CANCEL_FLG, '0') = '0' AND T1.PLAN_MONTH NOT IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(T1.PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN VALUE(T1.ADD_PLAN_CANCEL_FLG, '0') = '0' AND T1.PLAN_MONTH NOT IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(T1.ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTION_C_MONEY2, ";
        $query .= "     SUM(CASE WHEN VALUE(T1.PLAN_CANCEL_FLG, '0') = '0' ";
        $query .= "              THEN VALUE(T1.PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN VALUE(T1.ADD_PLAN_CANCEL_FLG, '0') = '0' ";
        $query .= "              THEN VALUE(T1.ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTION_C_MONEY ";
        $query .= " FROM ";
        $query .= "     REDUCTION_COUNTRY_PLAN_DAT T1 ";
        $query .= " WHERE ";
        $query .= "    T1.YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND (VALUE(T1.PLAN_CANCEL_FLG, '0') = '0' ";
        $query .= "         OR ";
        $query .= "         VALUE(T1.ADD_PLAN_CANCEL_FLG, '0') = '0') ";
        $query .= "    AND EXISTS( ";
        $query .= "           SELECT ";
        $query .= "               'x' ";
        $query .= "           FROM ";
        $query .= "               REDUC_T E1 ";
        $query .= "           WHERE ";
        $query .= "               E1.SCHREGNO = T1.SCHREGNO ";
        $query .= "    ) ";
        $query .= " GROUP BY ";
        $query .= "     T1.SCHREGNO ";
        $query .= " ) ";
        $query .= " SELECT ";
        $query .= "     '".CTRL_YEAR."', ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS LESSON_MONEY1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS LESSON_MONEY21, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS TOTAL_LESSON_MONEY, ";

        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS REDUCTIONMONEY1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS REDUCTIONMONEY2, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS TOTAL_REDUCTIONMONEY, ";

        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(L2.REDUCTION_C_MONEY1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS REDUCTION_COUNTRY_MONEY1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(L2.REDUCTION_C_MONEY2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS REDUCTION_COUNTRY_MONEY2, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          THEN VALUE(L2.REDUCTION_C_MONEY1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          THEN VALUE(L2.REDUCTION_C_MONEY2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS TOTAL_REDUCTION_COUNTRY_MONEY, ";

        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.REDUCTION_C_MONEY1, 0) > VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.REDUCTION_C_MONEY1, 0) - VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS ADJUSTMENT_MONEY1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.REDUCTION_C_MONEY2, 0) > VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.REDUCTION_C_MONEY2, 0) - VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS ADJUSTMENT_MONEY2, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.REDUCTION_C_MONEY1, 0) > VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.REDUCTION_C_MONEY1, 0) - VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.REDUCTION_C_MONEY2, 0) > VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          THEN VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.REDUCTION_C_MONEY2, 0) - VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS TOTAL_ADJUSTMENT_MONEY, ";

        $query .= "     '".STAFFCD."', ";
        $query .= "     sysdate() ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_T_MAIN T1 ";
        $query .= "     LEFT JOIN REDUC_T L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= "     LEFT JOIN REDUC_COUNTRY_T L2 ON T1.SCHREGNO = L2.SCHREGNO ";
        $query .= " WHERE ";
        $query .= "     (T1.MONEY_DUE1_FLG = '1' ";
        $query .= "      AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.REDUCTION_C_MONEY1, 0) > VALUE(T1.MONEY_DUE1, 0) ";
        $query .= "     ) ";
        $query .= "     OR ";
        $query .= "     (T1.MONEY_DUE2_FLG = '1' ";
        $query .= "      AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.REDUCTION_C_MONEY2, 0) > VALUE(T1.MONEY_DUE2, 0) ";
        $query .= "     ) ";

        $db->query($query);

        $db->commit();
        Query::dbCheckIn($db);
    }

    //データ更新
    function updateBurden($model)
    {
        $db = Query::dbCheckOut();
        $db->autoCommit(false);

        $query = "DELETE FROM REDUCTION_BURDEN_CHARGE_DAT WHERE YEAR = '".CTRL_YEAR."' ";
        $db->query($query);

        //相殺年月クリア
        $query  = " INSERT INTO REDUCTION_BURDEN_CHARGE_DAT ";
        $query .= " WITH MONEY_DUE_T AS ( ";
        $query .= " SELECT ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     L1.CURRICULUM_YEAR, ";
        $query .= "     SUM(T1.MONEY_DUE) / 4 AS MONEY_DUE1, ";
        $query .= "     SUM(T1.MONEY_DUE) / 4 * 3 AS MONEY_DUE2, ";
        $query .= "     SUM(T1.MONEY_DUE) AS MONEY_DUE ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_M_DAT T1 ";
        $query .= "     LEFT JOIN (SELECT DISTINCT ";
        $query .= "                  LT1.SCHREGNO, ";
        $query .= "                  LT1.CURRICULUM_YEAR ";
        $query .= "                FROM ";
        $query .= "                  SCHREG_ENT_GRD_HIST_DAT LT1, ";
        $query .= "                  (SELECT ";
        $query .= "                      I1.SCHREGNO, ";
        $query .= "                      I2.SCHOOL_KIND ";
        $query .= "                   FROM ";
        $query .= "                      SCHREG_REGD_DAT I1, ";
        $query .= "                      SCHREG_REGD_GDAT I2 ";
        $query .= "                   WHERE ";
        $query .= "                      I1.YEAR = '".CTRL_YEAR."' ";
        $query .= "                      AND I1.SEMESTER = '".CTRL_SEMESTER."' ";
        $query .= "                      AND I1.YEAR = I2.YEAR ";
        $query .= "                      AND I1.GRADE = I2.GRADE) LT2 ";
        $query .= "                WHERE ";
        $query .= "                  LT1.SCHREGNO = LT2.SCHREGNO ";
        $query .= "                  AND LT1.SCHOOL_KIND = LT2.SCHOOL_KIND ";
        $query .= "     ) L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= " WHERE ";
        $query .= "    T1.YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND T1.EXPENSE_M_CD IN ('11', '12', '13') ";
        $query .= " GROUP BY ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     L1.CURRICULUM_YEAR ";
        $query .= " ), MONEY_DUE_T_MAIN AS ( ";
        $query .= " SELECT ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     MAX1.REDUCTIONMONEY_1 AS MAX_REDUC1, ";
        $query .= "     MAX2.REDUCTIONMONEY_2 AS MAX_REDUC2, ";
        $query .= "     MAX1.MIN_MONEY_1 AS MIN_REDUC1, ";
        $query .= "     MAX2.MIN_MONEY_2 AS MIN_REDUC2, ";
        $query .= "     MAX1.PARENTS_MONEY_1, ";
        $query .= "     MAX2.PARENTS_MONEY_2, ";
        $query .= "     T1.MONEY_DUE1 AS SCHOOL_MONEY1, ";
        $query .= "     T1.MONEY_DUE2 AS SCHOOL_MONEY2, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1 > MAX1.REDUCTIONMONEY_1 ";
        $query .= "          THEN VALUE(T1.MONEY_DUE1, 0) - VALUE(MAX1.REDUCTIONMONEY_1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS MONEY_DUE1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1 > MAX1.REDUCTIONMONEY_1 ";
        $query .= "          THEN '1' ";
        $query .= "          ELSE '0' ";
        $query .= "     END AS MONEY_DUE1_FLG, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2 > MAX2.REDUCTIONMONEY_2 ";
        $query .= "          THEN VALUE(T1.MONEY_DUE2, 0) - VALUE(MAX2.REDUCTIONMONEY_2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS MONEY_DUE2, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2 > MAX2.REDUCTIONMONEY_2 ";
        $query .= "          THEN '1' ";
        $query .= "          ELSE '0' ";
        $query .= "     END AS MONEY_DUE2_FLG, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1 > MAX1.REDUCTIONMONEY_1 ";
        $query .= "          THEN VALUE(T1.MONEY_DUE1, 0) - VALUE(MAX1.REDUCTIONMONEY_1, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2 > MAX2.REDUCTIONMONEY_2 ";
        $query .= "          THEN VALUE(T1.MONEY_DUE2, 0) - VALUE(MAX2.REDUCTIONMONEY_2, 0) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     AS MONEY_DUE ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_T T1 ";
        $query .= "     LEFT JOIN SCHREG_BASE_MST L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= "     INNER JOIN REDUCTION_DAT I1 ON I1.YEAR = '".CTRL_YEAR."' ";
        $query .= "           AND T1.SCHREGNO = I1.SCHREGNO ";
        $query .= "     LEFT JOIN ( ";
        $query .= "             SELECT ";
        $query .= "                 REG.SCHREGNO, ";
        $query .= "                 MAX(REG.GRADE) AS GRADE ";
        $query .= "             FROM ";
        $query .= "                 SCHREG_REGD_DAT REG ";
        $query .= "             WHERE ";
        $query .= "                 REG.YEAR = '".CTRL_YEAR."' ";
        $query .= "             GROUP BY ";
        $query .= "                 REG.SCHREGNO ";
        $query .= "     ) REGD ON T1.SCHREGNO = REGD.SCHREGNO ";
        $query .= "     LEFT JOIN REDUCTION_PREF_GRADE_MST PREF_GRADE ON PREF_GRADE.YEAR = '".CTRL_YEAR."' ";
        $query .= "          AND I1.PREFECTURESCD = PREF_GRADE.PREFECTURESCD ";
        $query .= "          AND REGD.GRADE = PREF_GRADE.GRADE ";
        $query .= "     LEFT JOIN REDUCTION_MAX_MONEY_DAT MAX1 ON MAX1.YEAR || '-' || MAX1.GRADE = ";
        $query .= "                                                        CASE WHEN ".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 > 3 ";
        $query .= "                                                             THEN CAST(FISCALYEAR(L1.ENT_DATE) + 2 AS VARCHAR(4)) || '-03' ";
        $query .= "                                                             ELSE '".CTRL_YEAR."-0' || CAST(".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 AS VARCHAR(4)) ";
        $query .= "                                                        END ";
        $query .= "          AND I1.PREFECTURESCD = MAX1.PREFECTURESCD ";
        $query .= "          AND I1.REDUC_RANK_1 = MAX1.RANK_DIV ";
        $query .= "          AND T1.MONEY_DUE1 >= MAX1.REDUCTIONMONEY_1 ";
        $query .= "     LEFT JOIN REDUCTION_MAX_MONEY_DAT MAX2 ON MAX2.YEAR || '-' || MAX2.GRADE = ";
        $query .= "                                                        CASE WHEN ".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 > 3 ";
        $query .= "                                                             THEN CAST(FISCALYEAR(L1.ENT_DATE) + 2 AS VARCHAR(4)) || '-03' ";
        $query .= "                                                             ELSE '".CTRL_YEAR."-0' || CAST(".CTRL_YEAR." - FISCALYEAR(L1.ENT_DATE) + 1 AS VARCHAR(4)) ";
        $query .= "                                                        END ";
        $query .= "          AND I1.PREFECTURESCD = MAX2.PREFECTURESCD ";
        $query .= "          AND I1.REDUC_RANK_2 = MAX2.RANK_DIV ";
        $query .= "          AND T1.MONEY_DUE2 >= MAX2.REDUCTIONMONEY_2 ";
        $query .= "     WHERE ";
        $query .= "         MAX1.YEAR IS NOT NULL OR MAX2.YEAR IS NOT NULL ";
        $query .= " ), REDUC_T AS ( ";
        $query .= " SELECT ";
        $query .= "     SCHREGNO, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_1 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_1, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY1, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_2 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_2, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY2, ";
        $query .= "     SUM(CASE WHEN REDUC_DEC_FLG_1 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_1, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN REDUC_DEC_FLG_2 = '1' ";
        $query .= "              THEN VALUE(REDUCTIONMONEY_2, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS REDUCTIONMONEY ";
        $query .= " FROM ";
        $query .= "     REDUCTION_DAT ";
        $query .= " WHERE ";
        $query .= "    YEAR = '".CTRL_YEAR."' ";
        $query .= "    AND (REDUC_DEC_FLG_1 = '1' ";
        $query .= "         OR ";
        $query .= "         REDUC_DEC_FLG_2 = '1') ";
        $query .= " GROUP BY ";
        $query .= "     SCHREGNO ";
        $query .= " ), REDUC_CP_T AS ( ";
        $query .= " SELECT ";
        $query .= "     SCHREGNO, ";
        $query .= "     SUM(CASE WHEN VALUE(PLAN_CANCEL_FLG, '0') = '0' AND PLAN_MONTH IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS PLAN_MONEY1, ";
        $query .= "     SUM(CASE WHEN VALUE(PLAN_CANCEL_FLG, '0') = '0' AND PLAN_MONTH NOT IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS PLAN_MONEY2, ";
        $query .= "     SUM(CASE WHEN VALUE(ADD_PLAN_CANCEL_FLG, '0') = '0' AND PLAN_MONTH IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS ADD_PLAN_MONEY1, ";
        $query .= "     SUM(CASE WHEN VALUE(ADD_PLAN_CANCEL_FLG, '0') = '0' AND PLAN_MONTH NOT IN ('04', '05', '06') ";
        $query .= "              THEN VALUE(ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS ADD_PLAN_MONEY2, ";
        $query .= "     SUM(CASE WHEN VALUE(PLAN_CANCEL_FLG, '0') = '0' ";
        $query .= "              THEN VALUE(PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "         + ";
        $query .= "         CASE WHEN VALUE(ADD_PLAN_CANCEL_FLG, '0') = '0' ";
        $query .= "              THEN VALUE(ADD_PLAN_MONEY, 0) ";
        $query .= "              ELSE 0 ";
        $query .= "         END ";
        $query .= "     ) AS PLAN_MONEY ";
        $query .= " FROM ";
        $query .= "     REDUCTION_COUNTRY_PLAN_DAT ";
        $query .= " WHERE ";
        $query .= "    YEAR = '".CTRL_YEAR."' ";
        $query .= " GROUP BY ";
        $query .= "     SCHREGNO ";
        $query .= " ) ";
        $query .= " SELECT ";
        $query .= "     '".CTRL_YEAR."', ";
        $query .= "     T1.SCHREGNO, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.PLAN_MONEY1, 0) + VALUE(L2.ADD_PLAN_MONEY1, 0) + VALUE(T1.PARENTS_MONEY_1, 0) >= VALUE(T1.MIN_REDUC1, 0) ";
        $query .= "          THEN VALUE(T1.SCHOOL_MONEY1, 0) - (VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.PLAN_MONEY1, 0) + VALUE(L2.ADD_PLAN_MONEY1, 0) + VALUE(T1.PARENTS_MONEY_1, 0)) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS LESSON_MONEY1, ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.PLAN_MONEY2, 0) + VALUE(L2.ADD_PLAN_MONEY2, 0) + VALUE(T1.PARENTS_MONEY_2, 0) >= VALUE(T1.MIN_REDUC2, 0) ";
        $query .= "          THEN VALUE(T1.SCHOOL_MONEY2, 0) - (VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.PLAN_MONEY2, 0) + VALUE(L2.ADD_PLAN_MONEY2, 0) + VALUE(T1.PARENTS_MONEY_2, 0)) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS LESSON_MONEY21, ";
        $query .= "     CASE WHEN T1.MONEY_DUE1_FLG = '1' AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.PLAN_MONEY1, 0) + VALUE(L2.ADD_PLAN_MONEY1, 0) + VALUE(T1.PARENTS_MONEY_1, 0) >= VALUE(T1.MIN_REDUC1, 0) ";
        $query .= "          THEN VALUE(T1.SCHOOL_MONEY1, 0) - (VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.PLAN_MONEY1, 0) + VALUE(L2.ADD_PLAN_MONEY1, 0) + VALUE(T1.PARENTS_MONEY_1, 0)) ";
        $query .= "          ELSE 0 ";
        $query .= "     END ";
        $query .= "     + ";
        $query .= "     CASE WHEN T1.MONEY_DUE2_FLG = '1' AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.PLAN_MONEY2, 0) + VALUE(L2.ADD_PLAN_MONEY2, 0) + VALUE(T1.PARENTS_MONEY_2, 0) >= VALUE(T1.MIN_REDUC2, 0) ";
        $query .= "          THEN VALUE(T1.SCHOOL_MONEY2, 0) - (VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.PLAN_MONEY2, 0) + VALUE(L2.ADD_PLAN_MONEY2, 0) + VALUE(T1.PARENTS_MONEY_2, 0)) ";
        $query .= "          ELSE 0 ";
        $query .= "     END AS TOTAL_LESSON_MONEY, ";

        $query .= "     '".STAFFCD."', ";
        $query .= "     sysdate() ";
        $query .= " FROM ";
        $query .= "     MONEY_DUE_T_MAIN T1 ";
        $query .= "     LEFT JOIN REDUC_T L1 ON T1.SCHREGNO = L1.SCHREGNO ";
        $query .= "     LEFT JOIN REDUC_CP_T L2 ON T1.SCHREGNO = L2.SCHREGNO ";
        $query .= " WHERE ";
        $query .= "     T1.SCHREGNO NOT IN (SELECT I1.SCHREGNO FROM SCHREG_GRANT_DAT I1 WHERE I1.YEAR = '".CTRL_YEAR."') ";
        $query .= "     AND ( ";
        $query .= "         (T1.MONEY_DUE1_FLG = '1' ";
        $query .= "          AND VALUE(L1.REDUCTIONMONEY1, 0) + VALUE(L2.PLAN_MONEY1, 0) + VALUE(L2.ADD_PLAN_MONEY1, 0) + VALUE(T1.PARENTS_MONEY_1, 0) >= VALUE(T1.MIN_REDUC1, 0) ";
        $query .= "         ) ";
        $query .= "         OR ";
        $query .= "         (T1.MONEY_DUE2_FLG = '1' ";
        $query .= "          AND VALUE(L1.REDUCTIONMONEY2, 0) + VALUE(L2.PLAN_MONEY2, 0) + VALUE(L2.ADD_PLAN_MONEY2, 0) + VALUE(T1.PARENTS_MONEY_2, 0) >= VALUE(T1.MIN_REDUC2, 0) ";
        $query .= "         ) ";
        $query .= "     ) ";
        $db->query($query);

        $db->commit();
        Query::dbCheckIn($db);
    }

}
?>
