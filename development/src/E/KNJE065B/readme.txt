# kanji=漢字
KNJE065B
概評人数登録処理
----
学校：賢者版・・・近大以外

2007/08/24 nakamoto
★ 異動基準日を追加した。
-- 再計算で使用する条件である。
-- 退学・転学した生徒は人数には含まないので、
-- 異動基準日を指定して判断する。
-- ※退学・転学者は、異動基準日までは在学者である。
★ 選択科目を除くチェックボックスを追加した。
-- 再計算で使用する条件である。
-- schreg_studyrec_datから選択科目を除く

2007/09/04 nakamoto
★ 「概評人数登録処理」を新規作成した。
-- プログラムＩＤ KNJE065 を KNJE065B に変更しただけ

2008/06/25 nakamoto
★ 事前処理チェックの処理を移動した。
-- 修正前：画面を最初に開いた時にチェック
-- 修正後：「再計算」「更新」ボタンを押した時にチェック

2009/12/29  1.集計方法の修正STUDYRECの対象データは、各学年のMAX年度とする。

2010/07/08  1.プロパティーファイルで学科別、コース別を選択できるよう修正

2010/07/10 1.プロパティーの「gaihyouGakkaBetu」の意味を逆に変更、'1'の時コース別とする

2010/07/20  1.「評定1の場合は2で処理する」チェックボックスを追加
            -- prgInfo.propertiesで、チェックボックスの画面表示をコントロールする。
            --      # 評定読替するかしないかのフラグ 1:表示 1以外:非表示
            --      hyoteiYomikae = 1
            -- 再計算では、チェックがはいったら、評定1を2として、集計する。

2010/07/23 1.教科コード01～89を対象とする
           -- 法政：教科コード01～89 OR 科目コード = '941001'
           -- 自修館：教科コード01～85

2010/08/25  1.「再計算」処理の修正。
            -- 「不具合内容」
            -- 　　「調査書印刷」の「全体評定平均値」で数えた場合と、概評人数が合わない不具合の修正
            -- 「修正内容」
            -- 　　「調査書印刷」と同様に「科目マスタで、同一グループ科目設定されている場合」の対応

2011/07/27  1.「再計算」処理の修正。（評定平均の母集団となる成績データの条件を修正）
              修正前：在籍データを学年でグループ化したMAX年度の成績データを母集団とする。
              修正後：成績データを年次でグループ化したMAX年度の成績データを母集団とする。

2011/08/31  1.中高一貫の場合、DBエラーになる不具合を修正（前回の修正不足への対応。）

2012/07/13  1.教育課程の追加、追加に伴う修正
            -- Properties["useCurriculumcd"]=1のときのみ、教育課程処理に対応

2013/01/12  1.教科の教育課程CD削除

2013/07/25  1.プロパティProperties["gaihyouGakkaBetu"] === '2'の時、コースグループ別の一覧を表示する

2013/08/15  1.コースグループ選択時にコースグループコードをセットするよう修正
            2.修正
            3.プロパティProperties["gaihyouGakkaBetu"] === '2'の時のデータ表示を修正
            4.初期表示修正

2013/08/16  1.プロパティProperties["gaihyouGakkaBetu"] === '2'の時、COURSECODE='0000'固定にし、COURSE_GROUP_CD_HDAT.GROUP_CDをGENEVIEWMBR_DAT.MAJORCDに格納する

2013/12/20  1.集計対象からGRD_DIV='6'の除籍者を除くよう修正

2014/03/10  1.更新時のロック機能(レイヤ)を追加

2014/03/28  1.更新時のロック機能(レイヤ)修正

2014/04/25  1.更新時のロック機能(レイヤ)はプロパティ「useFrameLock」= '1'の時、有効

2014/08/27  1.ログ取得機能追加

2015/07/14  1.パラメータ「useAssessCourseMst」を追加

2015/12/21  1.「評定1の場合は2で処理する」は、仮評定の場合のみ2とする

2016/03/26  1.DBエラー修正

2016/07/27  1.7:転籍は除く

2016/09/21  1.校種条件追加
            -- プロパティー「useSchool_KindField」とSCHOOLKINDを参照

2016/12/06  1.学年コンボの名称をSCHREG_REGD_GDAT.GRADE_NAME1に変更

2017/02/21  1.駿台甲府はコース別の場合、学年人数に学科人数をセット

2017/05/01  1.ADMIN_CONTROL_PRG_SCHOOLKIND_MSTを使って、校種を制御する。
            --プロパティー追加：use_prg_schoolkind

2018/09/21  1.プロパティ「useKNJE065B_grdCreditSansyo」が'1'の時、
            --学校マスタの卒業履修単位数を参照した条件を母集団に追加する

2019/07/05  1.再計算、更新ボタン押下時の「ログイン年度のSCHREG_STUDYREC_DATがなければエラー」の処理をカット

2019/07/23  1.校種指定漏れによる算出バグ修正

2019/09/13  1.プロパティuseProvFlgが1でない場合のDBエラー対応

2020/09/08  1.プロパティKNJE065B_SetCommentExACDが1の時、生徒の評定平均が名称Mの'E073'名称1に登録した値以上なら
              マルA表示対象者 (HEXAM_ENTREMARK_HDAT.COMMENTEX_A_CD)に'1'を設定するよう、変更
              --プロパティー追加：KNJE065B_SetCommentExACD

2020/09/09  1.名称Mの'E073'の結合条件を修正
            2.評定平均を算出するデータの抽出条件として学年ではなく、校種を加味するよう、変更

2020/09/10  1.プロパティKNJE065B_SetCommentExACDが1の時、画面下に「※マルA更新処理含む」と表示するよう、変更

2021/02/04  1.コード自動整形
            2.リファクタ（knjCreate）

2021/02/22  1.コード自動整形
            2.プロパティーknje065b_showTajuHeikinが1の場合、平均種別コンボを表示し単純平均以外を選択した場合テーブルGENEVIEWMBR_KIND_DATを読込/書込する
            --新規テーブルgeneviewmbr_kind_dat.sql (6d6db07)
            3.プロパティーknje065b_showTajuHeikinが1の場合、多重平均で更新する際SCHREG_BASE_DETAIL_MSTに順位と平均点を更新する
            4.3.の多重平均順位母集団にプロパティーgaihyouGakkaBetuを反映した

2021/02/26  1.プロパティーknje065b_showTajuHeikinが1の場合、単純平均で更新する際にもSCHREG_BASE_DETAIL_MST(BASE_SEQ='018'、多重平均はBASE_SEQ='017')に順位と平均点を更新する
            2.2/22 4.の修正をカット(順位の母集団は学年とする)
            3.プロパティーknje065b_showTajuHeikinで単純平均は評定平均小数点第1位四捨五入、多重平均は小数点第2位切捨で順位づけする。

2021/03/03  1.評定平均の母集団に0を含めないよう修正 (調査書印刷、評定平均一覧に合わせた)
            2.プロパティーknje065bNotIncludeShutokuが1の場合、単位数が0のレコードを評定平均の母集団に含めないよう修正
