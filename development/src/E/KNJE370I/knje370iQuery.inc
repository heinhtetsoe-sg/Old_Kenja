<?php

require_once('for_php7.php');

class knje370iQuery extends Query {

    //CSV出力データ
    function getCsvQuery($model) {
        $query  = "";
        $query .= " WITH CALC_BASE AS ( ";
        $query .= "   SELECT ";
        $query .= "     YEAR ";
        $query .= "     , SCHOOL_CD ";
        $query .= "     , SUM(DOUBLE (JUDGE_DATE)) / COUNT(JUDGE_DATE) AS CRITERION_B ";
        $query .= "   FROM ";
        $query .= "     COLLEGE_EXAM_CALENDAR ";
        $query .= "   GROUP BY ";
        $query .= "     YEAR ";
        $query .= "     , SCHOOL_CD ";
        $query .= " ) ";
        $query .= " , CALC_SND AS ( ";
        $query .= "   SELECT ";
        $query .= "     T1.YEAR ";
        $query .= "     , T1.SCHOOL_CD ";
        $query .= "     , DECIMAL (INT (T1.CRITERION_B * 100 + 0.5) / 100.0, 5, 2) AS CRITERION_B ";
        $query .= "   FROM ";
        $query .= "     CALC_BASE T1 ";
        $query .= " ) ";
        $query .= " SELECT DISTINCT ";
        $query .= "   AFT1.YEAR+1 AS YEAR ";
        $query .= "   , AFT1.SEQ ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL THEN '1' ELSE '2' END AS OLDSCHREGTYPE ";
        $query .= "   , M1.SCHOOL_GROUP ";
        $query .= "   , REGDB.SCHREGNO ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NULL AND REGDB.GRD_DIV = '1' THEN FISCALYEAR(REGDB.GRD_DATE) ELSE '".CTRL_YEAR."' END AS GRD_DATE ";
        $query .= "   , REGDB.INOUTCD ";
        $query .= "   , N1.NAME1 AS INOUTCD_NAME ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL THEN REGD.GRADE ELSE GRD_REGD.GRADE END AS GRADE ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL THEN REGD.HR_CLASS ELSE GRD_REGD.HR_CLASS END AS HR_CLASS ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL ";
        $query .= "          THEN REGDH.HR_NAME || ' ' || REGD.ATTENDNO ";
        $query .= "          ELSE GRD_REGDH.HR_NAME || ' ' || GRD_REGD.ATTENDNO ";
        $query .= "     END AS HR_CLASS_NAME ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL THEN REGD.ATTENDNO ELSE GRD_REGD.ATTENDNO END AS ATTENDNO ";
        $query .= "   , REGDB.NAME ";
        $query .= "   , REGDB.NAME_SHOW ";
        $query .= "   , REGDB.NAME_KANA ";
        $query .= "   , '' AS FST_RATE_AVE ";
        $query .= "   , '' AS FST_RANK ";
        $query .= "   , '' AS END_RATE_AVE ";
        $query .= "   , '' AS END_RANK ";
        $query .= "   , CASE WHEN REGD.SCHREGNO IS NOT NULL ";
        $query .= "          THEN COURSE.COURSECODEABBV1 ";
        $query .= "          ELSE GRD_COURSE.COURSECODEABBV1 ";
        $query .= "     END AS COURSECODEABBV1 ";
        $query .= "   , AFT1.STAT_CD AS SCHOOL_CD ";
        $query .= "   , AFT1.FACULTYCD ";
        $query .= "   , AFT1.DEPARTMENTCD ";
        $query .= "   , CO1.PROGRAM_CD ";
        $query .= "   , CO1.FORM_CD ";
        $query .= "   , CO1.S_CD ";
        $query .= "   , M1.SCHOOL_NAME ";
        $query .= "   , M2.FACULTYNAME ";
        $query .= "   , M3.DEPARTMENTNAME ";
        $query .= "   , CO1.PROGRAM_NAME ";
        $query .= "   , CO1.FORM_NAME ";
        $query .= "   , CO1.S_NAME ";
        $query .= "   , CO1.ADVERTISE_FLG ";
        $query .= "   , CO1.BACHELOR_DIV ";
        $query .= "   , CO1.PREF_CD ";
        $query .= "   , CO1.CENTER_PARTICIPATE ";
        $query .= "   , CO1.WANTED_STUDENT_CNT ";
        $query .= "   , CO1.JUDGE_DATE ";
        $query .= "   , CO1.CENTER_JUDGE_B ";
        $query .= "   , CO1.L_CD1 ";
        $query .= "   , CO1.L_CD2 ";
        $query .= "   , CO1.L_CD3 ";
        $query .= "   , CO1.L_CD4 ";
        $query .= "   , CO1.L_CD5 ";
        $query .= "   , CO1.S_CD1 ";
        $query .= "   , CO1.S_CD2 ";
        $query .= "   , CO1.S_CD3 ";
        $query .= "   , CO1.S_CD4 ";
        $query .= "   , CO1.S_CD5 ";
        $query .= "   , CO1.S_CD6 ";
        $query .= "   , CO1.S_CD7 ";
        $query .= "   , CO1.S_CD8 ";
        $query .= "   , CO1.S_CD9 ";
        $query .= "   , CO1.S_CD10 ";
        $query .= "   , CO1.ADVERTISE_DIV ";
        $query .= "   , CO1.LIMIT_DATE_WEB ";
        $query .= "   , CO1.LIMIT_DATE_WINDOW ";
        $query .= "   , CASE WHEN CO1.LIMIT_MAIL_DIV != '1' THEN CO1.LIMIT_DATE_MAIL ELSE '' END LIMIT_DATE_MAIL ";
        $query .= "   , CASE WHEN CO1.LIMIT_MAIL_DIV = '1' THEN CO1.LIMIT_DATE_MAIL ELSE '' END LIMIT_DATE_MAIL2 ";
        $query .= "   , CO1.LIMIT_MAIL_DIV ";
        $query .= "   , CO1.EXAM_DATE ";
        $query .= "   , CO1.EXAM_PASS_DATE ";
        $query .= "   , CO1.PROCEDURE_LIMIT_DATE ";
        $query .= "   , CO1.ENT_MONEY ";
        $query .= "   , CO1.PROCEDURE_MONEY ";
        $query .= "   , CO1.TOTAL_MONEY ";
        $query .= "   , CO1.ACCEPTANCE_CRITERION_A ";
        $query .= "   , CO1.ACCEPTANCE_CRITERION_B ";
        $query .= "   , CO1.ACCEPTANCE_CRITERION_C ";
        $query .= "   , CO1.ACCEPTANCE_CRITERION_D ";
        $query .= "   , CO1.DOCKING_CRITERION_A ";
        $query .= "   , CO1.DOCKING_CRITERION_B ";
        $query .= "   , CO1.DOCKING_CRITERION_C ";
        $query .= "   , CO1.DOCKING_CRITERION_D ";
        $query .= "   , CO1.CENTER_CRITERION_A ";
        $query .= "   , CO1.CENTER_CRITERION_B ";
        $query .= "   , CO1.CENTER_CRITERION_C ";
        $query .= "   , CO1.CENTER_CRITERION_D ";
        $query .= "   , M1.SCHOOL_SORT ";
        $query .= "   , N2.NAME1 AS SCHOOL_SORT_NAME ";
        $query .= "   , ROUND(CS1.CRITERION_B,1) AS SSAVG ";
        $query .= "   , AFT1.HOWTOEXAM ";
        $query .= "   , N3.ABBV1 AS HOWTOEXAM_NAME ";
        $query .= "   , AFT1.DECISION ";
        $query .= "   , N4.NAME1 AS DECISION_NAME ";
        $query .= "   , AFT1.PLANSTAT ";
        $query .= "   , N5.NAME1 AS PLANSTAT_NAME ";
        $query .= "   , AFT3.REMARK1 AS SELECT_DIV ";
        $query .= "   , N6.ABBV1 AS SELECT_DIV_NAME ";
        //$query .= "   , AFT3.REMARK2 AS SELECT_RESULT ";
        $query .= "   , CASE WHEN AFT3.REMARK2 = '1' THEN '認定' ";
        $query .= "          ELSE CASE WHEN AFT3.REMARK2 = '2' THEN '×' ELSE '' END ";
        $query .= "     END AS SELECT_RESULT ";
        
        $query .= "   , N7.ABBV1 AS SELECT_RESULT_NAME ";
        $query .= "   , AFT3.REMARK3 AS SELECT_RANK ";
        $query .= "   , AFT1.STAT_DATE1 ";
        $query .= "   , AFT1.STAT_DATE3 ";
        $query .= " FROM ";
        $query .= "   AFT_GRAD_COURSE_DAT AFT1 ";
        $query .= "   LEFT JOIN AFT_GRAD_COURSE_DETAIL_DAT AFT2 ";
        $query .= "     ON AFT1.YEAR = AFT2.YEAR ";
        $query .= "     AND AFT1.SEQ = AFT2.SEQ ";
        $query .= "     AND AFT2.DETAIL_SEQ = '1' ";
        $query .= "   LEFT JOIN AFT_GRAD_COURSE_DETAIL_DAT AFT3 ";
        $query .= "     ON AFT1.YEAR = AFT3.YEAR ";
        $query .= "     AND AFT1.SEQ = AFT3.SEQ ";
        $query .= "     AND AFT3.DETAIL_SEQ = '6' ";

        $query .= "   LEFT JOIN COLLEGE_MST M1 ON AFT1.STAT_CD = M1.SCHOOL_CD ";
        $query .= "   LEFT JOIN COLLEGE_FACULTY_MST M2 ";
        $query .= "     ON AFT1.STAT_CD = M2.SCHOOL_CD ";
        $query .= "     AND AFT1.FACULTYCD = M2.FACULTYCD ";
        $query .= "   LEFT JOIN COLLEGE_DEPARTMENT_MST M3 ";
        $query .= "     ON AFT1.STAT_CD = M3.SCHOOL_CD ";
        $query .= "     AND AFT1.FACULTYCD = M3.FACULTYCD ";
        $query .= "     AND AFT1.DEPARTMENTCD = M3.DEPARTMENTCD ";

        $query .= "   LEFT JOIN SCHREG_BASE_MST REGDB ";
        $query .= "     ON AFT1.SCHREGNO = REGDB.SCHREGNO ";
        $query .= "   LEFT JOIN SCHREG_REGD_DAT REGD ";
        $query .= "     ON AFT1.SCHREGNO = REGD.SCHREGNO ";
        $query .= "     AND AFT1.YEAR = REGD.YEAR ";
        $query .= "     AND REGD.SEMESTER = '".CTRL_SEMESTER."' ";
        $query .= "   LEFT JOIN SCHREG_REGD_HDAT REGDH ";
        $query .= "     ON REGD.YEAR = REGDH.YEAR ";
        $query .= "     AND REGD.SEMESTER = REGDH.SEMESTER ";
        $query .= "     AND REGD.GRADE = REGDH.GRADE ";
        $query .= "     AND REGD.HR_CLASS = REGDH.HR_CLASS ";
        $query .= "   LEFT JOIN COURSECODE_MST COURSE ";
        $query .= "     ON REGD.COURSECODE = COURSE.COURSECODE ";
        $query .= "   LEFT JOIN (SELECT T1.* FROM SCHREG_REGD_DAT T1 ";
        $query .= "                               INNER JOIN ( SELECT MAX(YEAR||SEMESTER) AS YEAR_SEMESTER, ";
        $query .= "                                                   SCHREGNO ";
        $query .= "                                              FROM SCHREG_REGD_DAT ";
        $query .= "                                             GROUP BY SCHREGNO ";
        $query .= "                                          ) T2 ";
        $query .= "                                       ON T2.YEAR_SEMESTER = T1.YEAR||T1.SEMESTER ";
        $query .= "                                      AND T2.SCHREGNO      = T1.SCHREGNO ";
        $query .= "             ) GRD_REGD ";
        $query .= "      ON AFT1.SCHREGNO = GRD_REGD.SCHREGNO ";
        $query .= "   LEFT JOIN SCHREG_REGD_HDAT GRD_REGDH ";
        $query .= "      ON GRD_REGD.YEAR     = GRD_REGDH.YEAR ";
        $query .= "     AND GRD_REGD.SEMESTER = GRD_REGDH.SEMESTER ";
        $query .= "     AND GRD_REGD.GRADE    = GRD_REGDH.GRADE ";
        $query .= "     AND GRD_REGD.HR_CLASS = GRD_REGDH.HR_CLASS ";
        $query .= "   LEFT JOIN COURSECODE_MST GRD_COURSE ";
        $query .= "     ON GRD_REGD.COURSECODE = GRD_COURSE.COURSECODE ";
        $query .= "   LEFT JOIN COLLEGE_EXAM_CALENDAR CO1 ";
        $query .= "     ON AFT1.YEAR = CO1.YEAR ";
        $query .= "     AND AFT1.STAT_CD = CO1.SCHOOL_CD ";
        $query .= "     AND AFT1.FACULTYCD = CO1.FACULTYCD ";
        $query .= "     AND AFT1.DEPARTMENTCD = CO1.DEPARTMENTCD ";
        $query .= "     AND AFT2.REMARK2 = CO1.PROGRAM_CD ";
        $query .= "     AND AFT2.REMARK3 = CO1.FORM_CD ";
        $query .= "     AND AFT2.REMARK5 = CO1.S_CD ";
        $query .= "   LEFT JOIN CALC_SND CS1 ";
        $query .= "     ON AFT1.YEAR = CS1.YEAR ";
        $query .= "     AND AFT1.STAT_CD = CS1.SCHOOL_CD ";
        $query .= "   LEFT JOIN V_NAME_MST N1 ";
        $query .= "     ON REGDB.INOUTCD = N1.NAMECD2 ";
        $query .= "     AND N1.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N1.NAMECD1 = 'A001' ";
        $query .= "   LEFT JOIN V_NAME_MST N2 ";
        $query .= "     ON N2.NAMECD2 = M1.SCHOOL_SORT";
        $query .= "     AND N2.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N2.NAMECD1 = 'E001' ";
        $query .= "   LEFT JOIN V_NAME_MST N3 ";
        $query .= "     ON AFT1.HOWTOEXAM = N3.NAMECD2 ";
        $query .= "     AND N3.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N3.NAMECD1 = 'E002' ";
        $query .= "   LEFT JOIN V_NAME_MST N4 ";
        $query .= "     ON AFT1.DECISION = N4.NAMECD2 ";
        $query .= "     AND N4.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N4.NAMECD1 = 'E005' ";
        $query .= "   LEFT JOIN V_NAME_MST N5 ";
        $query .= "     ON AFT1.PLANSTAT = N5.NAMECD2 ";
        $query .= "     AND N5.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N5.NAMECD1 = 'E006' ";
        $query .= "   LEFT JOIN V_NAME_MST N6 ";
        $query .= "     ON AFT3.REMARK1 = N6.NAMECD2 ";
        $query .= "     AND N6.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N6.NAMECD1 = 'E054' ";
        $query .= "   LEFT JOIN V_NAME_MST N7 ";
        $query .= "     ON AFT3.REMARK2 = N7.NAMECD2 ";
        $query .= "     AND N7.YEAR = '".CTRL_YEAR."' ";
        $query .= "     AND N7.NAMECD1 = 'E055' ";
        $query .= " WHERE ";
        $query .= "   AFT1.YEAR = '".CTRL_YEAR."' ";
        $query .= "   AND AFT1.SENKOU_KIND = '0' ";
        if ($model->field["TARGET_DIV"] == 1) {
            $query .= "   AND N4.NAMESPARE1 = '3' ";
        }

        $query .= " ORDER BY ";
        $query .= "   OLDSCHREGTYPE, ";
        $query .= "   GRADE, ";
        $query .= "   HR_CLASS, ";
        $query .= "   ATTENDNO ";

        return $query;
    }

    function getClassMst($classcds) {
        $query  = " SELECT ";
        $query .= "     CLASSCD || '-' || SCHOOL_KIND AS CLASSCD, CLASSNAME ";
        $query .= " FROM ";
        $query .= "     CLASS_MST ";
        $query .= " WHERE ";
        $query .= "     CLASSCD || '-' || SCHOOL_KIND IN ('".implode("','", $classcds)."')";
        $query .= " ORDER BY ";
        $query .= "     SCHOOL_KIND, CLASSCD ";
        return $query;
    }
}
?>
