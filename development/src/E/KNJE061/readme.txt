/*** KNJE061_科目読替処理 readme.txt***/
$Id: readme.txt 76308 2020-08-28 08:11:49Z arakaki $
2005/01/09 成績テーブル変更に伴う修正

2005.11.08 ALP修正：OFFDAYS(休学日数),ABROAD(留学日数)を
                    attend_semes_datのOFFDAYS(休学日数),ABROAD(留学日数)から集計するように変更
2006/07/04 o-naka 学籍出欠記録データの生成のＳＱＬを一時的に修正（annual→grade）

2006/09/01 o-naka
★ 成績データ生成の実行時、資格データからも同時に取込む処理を追加した。
   -- 資格データの設定区分=1,2の単位数を学習記録データの増加修得単位に登録する
   -- 資格データの設定区分=3の単位数を学習記録データの標準修得単位に登録する
★ 成績データ生成の実行時、下記の項目は登録しないように修正した。
   -- 教科（名称、略称、名称英字、略称英字）と科目（数、名称、略称、名称英字、略称英字）

2006/09/07 o-naka
★ 成績データ生成の実行時、単位マスタ(の無条件履修フラグがＯＮ)からも同時に取込む処理を追加した。
   -- 成績データの標準修得単位が is not null のデータは除く

2006/09/08 o-naka
★ CSVの「テンプレート書出しボタン」を追加した。

2006/09/27 o-naka
★ 成績データ生成の実行時、資格データからも同時に取込む処理を変更した。
   -- 資格データの設定区分=1,2の単位数を学習記録データの増加修得単位に登録する
      ただし、学習記録データの本校区分=0として登録する
   -- 資格データの設定区分=3の単位数を学習記録データの標準修得単位に登録する
      ただし、学習記録データの本校区分=2として登録する

2006/09/28 o-naka
★ 成績データ生成の実行時、以下の仕様を追加した。
   -- 資格データの備考を学習記録備考データの備考に登録する

2007/07/26 o-naka 以下の通り、法政・自修館の処理を追加した。
主なテーブル
・NAME_MST
・SUBCLASS_REPLACE_COMBINED_DAT
・CREDIT_MST
・RECORD_RANK_DAT
・RECORD_SCORE_DAT
★ 以下の場合、成績得点データ（RECORD_SCORE_DAT）を参照するようにした。
-- 名称マスタ（NAME_MST）
-- 区分（NAMECD1）＝ 'Z010'
-- コード（NAMECD2）＝ '00'
-- 予備１（NAMESPARE1）＝ '1'
-- 学校：法政・自修館
★ 以下の場合、法政と判断するようにした。
-- 名称マスタ（NAME_MST）
-- 区分（NAMECD1）＝ 'Z010'
-- コード（NAMECD2）＝ '00'
-- 名称１（NAME1）＝ 'HOUSEI'
-- 学校：法政
★ 評定が１００段階なので、学年評定を５段階に変換するようにした。
-- 評定マスタ（ASSESS_MST）
-- 評定区分（ASSESSCD）＝ '3'
-- ASSESSLOW <= 学年評定 <= ASSESSHIGH
-- ASSESSLEVELに変換
-- 学校：法政
★ 合併先科目のデータを作成するようにした。
-- 合併元科目のデータは作成しない
-- 成績席次データに合併先科目がないことを前提とする
-- 学校：法政

2007/10/12 o-naka 以下の通り、学籍学習記録データの履修単位への対応をした。
現在、学籍資格データから学籍学習記録データを生成する際、学籍資格データの「単位数（CREDITS）」の値は、
・「増加単位認定」と「学校外認定」（CONDITION_DIV＝１or２）の場合、学籍学習記録データの「増加単位（ADD_CREDIT）」
・「高等学校卒業程度認定単位」（CONDIVION_DIV＝３）の場合、学籍学習記録データの「標準修得単位（GET_CREDIT）」
にコピーされている。
この値を、学籍学習記録データの「履修単位（COMP_CREDIT）」にもコピーするようにする。

※注意点
この際、CONDITION_DIV＝１or２（増加認定単位・学校外認定）の単位については注意が必要。
同一年度に学校で履修している科目と同じ科目でこれらの単位を修得した場合、学籍学習記録データとしては同じ
レコードにまとめられる（「本校区分＝０」のレコードとして）。その場合
・学校の授業で修得した単位・・・標準修得単位と履修単位
・増加認定単位・学校外認定・・・増加単位
このデータの履修単位は、「履修単位」と「増加単位」２つの単位を足した値を登録する。

2008/04/25 o-naka
★ 奉仕の評定は、調査書指導要録データにセットしない。
-- 「調査書指導要録データにセットしない科目」とは、
-- ・名称マスタのNAMECD1=D008のNAMECD2に教科コードが登録されている科目
-- である。

2008/05/02 o-naka
★ 以下の通り修正した。
-- 学籍学習記録データ（SCHREG_STUDYREC_DAT）生成する時に
-- 学籍資格データ（SCHREG_QUALIFIED_DAT）を参照する場合、
-- 学籍資格データの「単位（CREDITS）」がNULLのレコードについては、
-- 学籍学習記録データに内容を反映させない。
-- ※単位がゼロのレコードは反映させること。

2008/07/14 o-naka
★ 仕様変更。法政・自修館以外の場合、RECORD_SCORE_DATのVALUEをセットする。
★ エラー対応。SQL0901N

2008/07/28 o-naka
★ 参照するテーブルを変更した。
-- v_regdyear_xxx_dat → schreg_regd_dat

2008/10/09 o-naka
★ 前回修正分を元に戻した。
-- 参照するテーブルを変更した。
-- schreg_regd_dat → v_regdyear_xxx_dat
※前回は、一時的な対応であった。

2008/10/15 o-naka
★ v_regdyear_xxx_dat および schreg_regd_dat の参照条件を変更した。
-- ・v_regdyear_xxx_dat
-- 　「今年度、今学期、指定学年」の「今学期」をカット。
-- ・schreg_regd_dat
-- 　「今年度、今学期、指定学年」の「今学期」を「今年度の最大学期」に変更。
-- 　「今年度の最大学期」は、schreg_regd_dat から取得


2010/01/07  1.組コンボの表示を年組名称を出力するように変更
            2.文字変更。「組」⇒「年組」

2010/02/18  1.教科コード９０の成績データは、評定がＮＵＬＬでも取込むように修正した。

2010/02/24  1.学習記録備考データが正しく取込まれない不具合を修正。

2010/06/02  1.「出欠データ」もCSV取込みできるよう修正

2010/06/08  1.CSVの見本のずれの修正

2010/08/27  1.出欠・成績データのロックの対応

2011/01/27  1.生成データラジオボタンに「○観点データ」を追加。
            -- SCHREG_REGD_GDATのSCHOOL_KINDに「'P'または'J'」があれば表示。

2011/02/07  1.RECORDE_SCORE_DAT使用で、自修館／法政以外の場合。評定がＮＵＬＬでも取込むように修正した。

2011/02/09  1.RECORDE_SCORE_DAT使用で、自修館／法政以外の場合。評定がＮＵＬＬ・履修単位がＮＵＬＬ・修得単位がＮＵＬＬは取込まないように修正した。

2011/07/04  1.生成データラジオボタン「○観点データ」の表示条件を修正。
            -- 修正前：
            -- SCHREG_REGD_GDATのSCHOOL_KINDをグループ化して「'P'または'J'」があれば表示。
            -- 修正後：
            -- prgInfo.propertiesの"KNJE061_JVIEWSTAT_RECORD_DAT"が’1’のとき表示。

2011/07/20  1.広島国際(hirogaku)の場合、総合学習(900100)とＬＨＲ(940000)の生成処理を追加した。
            -- 講座名簿に登録されている生徒は、データ生成する。
            -- 履修単位(COMP_CREDIT)・修得単位(GET_CREDIT)は、単位マスタの単位数を無条件に与える。

2011/09/07  1.途中退学者の対応。
            -- 在籍データは、生徒のMAX学期のレコードを参照。
            -- 「MAX学期の条件を使用する」をカット。

2012/02/20  1.JVIEWSTAT_RECORD_DATのSTATUSとリンクするフィールドを変更
            -- 変更前：名称マスタ「D028」「NAME1」
            -- 変更後：名称マスタ「D028」「ABBV1」
            2.JVIEWSTAT_SUB_DATのSTATUSにセット（更新）するフィールドを変更
            -- 変更前：名称マスタ「D028」「NAME1」
            -- 変更後：名称マスタ「D028」「ABBV1」

2012/02/23  1.出力条件のコースのコンボボックスの枠を全角15文まで表示されるよう修正
            2.出力条件のコースのコンボボックスの枠を元に戻し（全角10文字程度）、コース名の長さによってコンボの長さが変わるように修正

2012/03/02  1.名称マスタ「D028」「NAMESPARE1」とのリンクをカット

2012/03/20  1.プロパティ追加(useStudyrecRemarkQualifiedDat)に伴い修正
            -- 調査書データ取込(自動生成)でどの資格データへ取込むか
            -- 1:STUDYRECREMARK_QUALIFIED_DAT それ以外:STUDYRECREMARK_DAT
            2.コースコンボボックスのサイズを全角11文字程度に修正

2012/04/10  1.出欠・成績データのロックの仕様変更
            -- 変更前：LAST_OPI_SEQ の値があればロックする
            -- 変更後：CHAGE_OPI_SEQ の値があればロックする
            2.観点データもロックする

2012/07/12  1.教育課程の追加、追加に伴う修正
            -- Properties["useCurriculumcd"]=1のときのみ、教育課程処理に対応

2013/01/11  1.CLASS_MSTテーブルのCURRICULUM_CDをカット

2013/03/15  1.以下の不具合を修正
            -- 自動生成の新規作成：対象生徒のデータを全て削除して追加
            -- を選択したときにSTUDYRECREMARK_QUALIFIED_DATのデータ
            -- が削除されない。

2013/04/03  1.名称マスタ「D027」「01」「NAMESPARE1」に「3:設定」追加に伴い修正
            -- ※通知票観点を指導要録観点に変換する際、
            -- ・通知票観点が２件以上ある場合
            -- 　JVIEWSTAT_LEVEL_MSTの「DIV = '3'」を参照
            -- 　JVIEWSTAT_RECORD_DATの各学期を参照
            -- ・それ以外の場合・・・賢者と同じ仕様
            -- 　JVIEWSTAT_RECORD_DATの9学期を参照
            
2013/07/11  1.名称マスタのマスタ化に伴う修正

2013/08/05  1.パーツタイプ対応のため修正
            -- プロパティuseTestCountflg = TESTITEM_MST_COUNTFLG_NEW_SDIVの時
            -- RECORD_SCORE_DATは、SCORE_DIV = '09'のSCOREを参照する。
            2.仮評定フラグのコピーを追加
            -- RECORD_PROV_FLG_DATからSTUDYREC_PROV_FLG_DATへコピーする。
            -- ※宮城県・常磐からの要望

2013/08/13  1.DI_CD'19','20'ウイルス追加に伴う修正
            -- rep-attend_semes_dat.sql(rev1.8)
            -- rep-attend_subclass_dat.sql(rev1.10)
            -- v_attend_semes_dat.sql(rev1.6)
            -- v_attend_subclass_dat.sql(rev1.3)

2013/08/14  1.DI_CD'25','26'交止追加に伴う修正
            -- rep-attend_semes_dat.sql(rev1.9)
            -- rep-attend_subclass_dat.sql(rev1.11)
            -- v_attend_semes_dat.sql(rev1.7)
            -- v_attend_subclass_dat.sql(rev1.4)
            -- v_school_mst.sql(rev1.20)

2014/03/10  1.更新時のロック機能(レイヤ)を追加

2014/03/28  1.更新時のロック機能(レイヤ)修正

2014/04/25  1.更新時のロック機能(レイヤ)はプロパティ「useFrameLock」= '1'の時、有効

2014/08/07  1.仮評定の追加対応するプロパティ追加
            -- useProvFlg = '1'の時のみ対応する

2014/08/27  1.ログ取得機能追加

2014/12/11  1.観点データ生成処理の追加に伴う修正
            -- プロパティuseFromStudyrecToJviewstatが１のとき、
            -- 「観点データ（中学）」チェックボックスを表示する。
            -- 成績データラジオボタンの下に表示
            ※ 2014/11/27メール参照

2015/03/02  1.観点データ生成処理の追加に伴う修正
            ・プロパティuseKantenGakunenSeiseki追加
            ・プロパテイーで、コメント”（学年成績から自動算出）”表示をコントロールする。
            ・実行では、プロパテイー’1’の時は、成績データの学年成績から、
              jview_cnt_mst　を参照して、観点データを作成する。
            ※ 海城からの要望）2015/02/28メール参照

2015/04/14  1.以下の通り修正
            -- プロパティuseFromStudyrecToJviewstatが１のとき、
            -- 元科目の成績データから先科目の学習記録データを生成する処理を追加
            ※ 大宮からの要望

2015/05/21  1.以下の通り修正
            -- CSVのファイルからの取り込みした時、仮評定は本評定に変更するため、
            -- プロパティuseProvFlg=1のとき、CSVで取り込みした科目は、STUDYREC_PROV_FLG_DATから削除する。

2015/05/22  1.前回の修正変更
            -- プロパティuseProvFlg=1の時、
            -- 【テンプレート】を出力した時は、仮評定フラグ欄を追加
            -- CSV【実行】の時は、
            -- 　仮評定フラグ欄が、nullの時は、STUDYREC_PROV_FLG_DATのレコードを削除
            -- 　仮評定フラグ欄が、1の時は、STUDYREC_PROV_FLG_DATのレコードを作成

2015/05/27  1.仕様追加：指導要録観点から、評定を生成
            -- プロパティuseKantenToStudyRecが１の場合のみ生成
            -- 重み参照
            ※武蔵野東

2015/05/29  1.プロパティuseKantenToStudyRec = 1　の時
            -- （観点から評定を生成）とコメント表示
            ※武蔵野東

2015/06/12  1.観点データ生成を修正
            -- 武蔵野東の場合、通知票観点を指導要録観点に変換する際、
            -- JVIEWNAME_GRADE_DETAIL_MSTを参照
            -- JVIEWSTAT_RECORD_DATの各学期を参照

2015/08/26  1.成績生成の「合併元科目は作成しない」処理について、海城はSUBCLASS_REPLACE_COMBINED_DATの代わりにSUBCLASS_WEIGHTING_COURSE_DATを使用する

2016/02/25  1.指導要録の仮評定フラグが上書きされない不具合修正

2016/03/23  1.仮評定テーブルについて、フィールド追加に伴い修正
            -- PROV_SEMESTER
            -- PROV_TESTKINDCD
            -- PROV_TESTITEMCD
            -- PROV_SCORE_DIV
            --     record_prov_flg_dat.sql(1.3)
            -- rep-record_prov_flg_dat.sql(1.2)
            --     studyrec_prov_flg_dat.sql(1.3)
            -- rep-studyrec_prov_flg_dat.sql(1.2)
            ※ ＣＳＶ取込は保留

2016/03/30  1.knje061Query.incのインデント修正
            2.プロパティknje061CreateSchregStudyecDatE047J=1の時、中学のSCHREG_STUDYREC_DAT作成は名称マスタE047指定の科目コードのみ取り込む

2016/04/04  1.成績データの新規作成指定の科目ごとの備考取り込みを変更
             -- 変更前：更新対象（選択された生徒で、署名されていない）のSTUDYRECREMARK_DATを全削除してSCHREG_QUALIFIED_DATから取り込む。
             -- 変更後：更新対象（選択された生徒で、署名されていない）でSCHREG_QUALIFIED_DATから取り込むデータのみSTUDYRECREMARK_DATを削除して追加する。それ以外は削除も修正もしない。

2016/04/21  1.大宮にて、先科目の学籍学習記録データが生成されない不具合修正
            2.ＤＢエラー修正

2016/05/10  1.観点データの過年度対応

2016/09/21  1.校種条件追加
            -- プロパティー「useSchool_KindField」とSCHOOLKINDを参照

2016/11/21  1.実行履歴を追加
            -- schreg_studyrec_exec_dat.sql(1.1)

2016/11/22  1.実行履歴に仮評定の表示を追加。
            -- schreg_studyrec_exec_dat.sql(1.2)
            2.レイアウト修正

2016/12/02  1.生成データラジオボタンに「○行動の記録他」を追加。
            -- プロパティー「useFromStudyrecToBehavior」が１の時、表示する。
            -- 小学・中学が使用する。

2016/12/07  1.「○行動の記録他」の指導要録用所見生成を変更。
            -- 対象の通知票所見を9学期のみ、対象科目を名称マスタ「D008」の名称予備1='1'設定のみに変更
            -- 文言評価は5段階評定を定型文データ(区分02)に変換して取り込む。 

2017/01/10  1.通信制（名称マスタ「Z010」のNAMESPARE3が'1'）は実行は不可

2017/02/01  1.観点データ生成を修正
            -- 駿台甲府小学

2017/03/07  1.ＤＢエラー対応「行動の記録他」
            -- 原因：NOT NULL項目にNULLを追加しようとして、ＤＢエラー発生
            -- 対応：NOT NULL条件追加
            2.行動の記録(小学)の場合、BEHAVIOR_DATのDIV = '3'に修正

2017/03/15  1.「行動の記録他」で武蔵野東は行動の記録以外更新しない

2017/08/21  1.成績データを選択してサブミットすると生成方法が選択できない不具合を修正

2017/09/08  1.ADMIN_CONTROL_PRG_SCHOOLKIND_MSTを使って、校種を制御する。
            --プロパティー追加：use_prg_schoolkind

2018/03/06  1.ＤＢエラー対応
            --原因：ファイルからの取り込みの時、NOT NULL項目にNULLを追加しようとして、ＤＢエラー発生
            --対応：ファイルからの取り込みの時、実行履歴テーブルの校種にはログイン校種（SCHOOLKIND）をセットする。
            ※成城から指摘

2018/03/29  1.プロパテイー「useRecordDat = RECORD_SCORE_HIST_DAT」の対応
            --RECORD_SCORE_HIST_DATから成績を生成できるように修正
            ※広工大通信制から要望

2018/07/10  1.成績データを生成する時の自動生成方法の選択初期値を「新規作成」から「追加上書」に変更
            --先生が誤ってデータを消してしまうことが多いため

2018/08/23  1.ログイン年度が名称マスタ「E060」「NAME1」に登録されている年度の時は、【実行】ボタン使用不可とする。
            2.生成範囲の行はカット。常に「処理年度のみ」で処理する。

2018/08/28  1.観点データ生成処理の追加に伴う修正
            -- プロパティー「useKantenGakunenSeiseki = 2」の時、
            -- 観点データラジオボタンの下にコメント表示「（学年成績から自動算出）」
            -- 成績データ(9-990008)から観点データを生成（観点変換テーブル参照）
            -- jview_sub_mst.sql (rev.61979)
            ※玉川聖からの要望

2018/10/16  1.観点データ生成処理の追加に伴う修正（前回の変更）
            -- プロパティー「useKantenGakunenSeiseki = 3」の時、
            -- プロパティー「useKantenGakunenSeiseki = 2」の時と同様に処理する。但し、観点はランダムに割振る。
            -- 元になる成績のテスト種別は、固定「9990008」から名称マスタ「E064」「NAME1」を参照するように変更
            ※成城からの要望

2019/02/22  1.新規作成で備考データ(STUDYRECREMARK_DAT)が削除されない不具合修正
            --追加上書で備考データ(STUDYRECREMARK_DAT)が上書されない不具合修正

2019/03/07  1.「行動の記録の」通知票所見取込みについて、名称マスタ「D008」の略称3に取込学期がセットされていた場合、9学期に優先する

2019/03/18  1.評定から観点データをランダム生成の修正
            -- 開智未来の場合
            -- 評定5　⇒　観点すべてA
            -- 評定4　⇒　観点2つB/その他A
            -- 評定3　⇒　観点すべてB
            -- 評定2　⇒　観点3つB/その他C
            -- 評定1　⇒　観点すべてC

2019/05/20  1.RECORDE_SCORE_DAT使用で、「評定がＮＵＬＬ・履修単位がＮＵＬＬ・修得単位がＮＵＬＬは取込まない」条件をカット

2019/07/02  1.条件範囲に集計月コンボ追加
            -- 出欠データ生成時のみ選択可とする
            -- 集計月の最後をデフォルト値とする
            -- 出欠データは選択した集計月までの範囲内のデータを生成する
            ※長野清泉から要望

2019/08/20  1.Warning対応

2020/05/14  1.名称マスタ「"D" + "校種" + "08"」が1件でもあれば「"D" + "校種" + "08"」を参照する
             -- 上記以外は「D008」を使用

2020/07/15  1.プロパティ「useRecordDat」= "RECORD_SCORE_HIST_DAT"の場合に以下の仕様を追加
            --プロパティ「KNJE061_RECORD_SCORE_HIST_DAT」= "SCORE"の場合、RECORD_SCORE_HIST_DATのSCOREから成績を生成する
            2.不要なコメントを削除

2020/08/28  1.CSV DUMMYの名称をLASTCOLUMNに修正

2020/11/26  1.コード自動整形
            2.観点データ生成処理に立命館小学用仕様を追加

2020/12/01  1.CSVの最終列をDUMMYかLASTCOLUMNで扱うかを
              設定ファイル「prgInfo.properties」のプロパティー「csv_LastColumn」で
              切り替えるように変更

2021/02/24  1.CSVメッセージ統一(SG社)

2021/03/24  1.大阪信愛の観点取込、評定取込の処理を追加 
            -- 観点取込: 各学期の通知票観点を指導要録観点コードごとにA2/3以上がA、C1/3以上がC、それ以外をBとする
            -- 評定取込: 各学期の通知票評価1、2、3を各0、5、10に換算し指導要録観点コードごとに合計して0～9を1、10～20を2、21～30を3とする
